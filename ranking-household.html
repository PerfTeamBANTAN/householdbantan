<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rangking Household — Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --black:#0b0b0b;
      --header-blue:#2f6fb8;
      --target-red:#d94b4b;
      --muted:#6b6b6b;
      --light-gray:#f7f7f7;
      --cell-border:#e6e6e6;
      --agent-col-w:70px; /* lebar setiap kolom agent */
      --agent-header-h:120px; /* tinggi area header sebelum rotasi */
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #fff;
      color: #222;
      padding-top: 70px;
    }

    .container-main { max-width:1300px; margin:0 auto; }

    .page-header { display:flex; align-items:center; gap:12px; margin-bottom: 18px; }
    .page-title { font-weight:700; font-size:20px; }

    .rank-wrapper { overflow:auto; background:#fff; padding:10px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.04); }

    /* Fixed layout so columns predictable */
    table.rank-table { border-collapse: collapse; width:100%; table-layout: fixed; min-width: 1200px; }
    table.rank-table thead th, table.rank-table tbody td {
      border:1px solid var(--cell-border);
      padding:6px;
      vertical-align:middle;
      font-size:13px;
    }

    /* Left columns widths */
    th.idx, td.idx { width:260px; text-align:left; background:var(--light-gray); font-weight:700; padding:10px; }
    th.target, td.target { width:90px; text-align:center; font-weight:700; }

    /* Agent columns fixed width */
    th.agent, td.agent { width: var(--agent-col-w); max-width: var(--agent-col-w); text-align:center; padding:6px; }

    /* Top header row style (we will keep it visually compact) */
    thead tr.top-row th {
      background: var(--black);
      color:#fff;
      font-weight:700;
      text-align:center;
      padding:6px 6px;
      white-space:nowrap;
      font-size:12px;
    }

    /* The header cell that contains the rotated block (for each agent) */
    thead tr.top-row th.agent {
      padding:0;
      height: var(--agent-header-h);
      vertical-align:bottom;
    }

    /* sub-row will be hidden visually because we combine label into rotated block */
    thead tr.sub-row { display:none; }

    /* Rotated label container inside th */
    .rotated {
      width: var(--agent-col-w);
      height: var(--agent-header-h);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }

    .rotated .text {
      transform: rotate(-90deg);
      transform-origin: center;
      white-space:nowrap;
      font-weight:700;
      font-size:12px;
      color:#fff;
      display:block;
      padding:0 6px;
    }

    /* We'll create a stacked visual: black top (name) and blue bottom (Growth Point) inside rotated box */
    .rotated .name {
      background: var(--black);
      display:block;
      padding:6px 8px;
    }
    .rotated .sub {
      background: var(--header-blue);
      display:block;
      padding:4px 8px;
      font-size:11px;
      font-weight:600;
    }

    /* TARGET red cell style (if has word 'TARGET' or empty) */
    .cell-target { background: var(--target-red); color:#fff; }

    /* Group header full-width row */
    .group-header {
      background: var(--black);
      color:#fff;
      font-weight:700;
      padding:8px 12px;
      text-align:left;
    }

    /* Number cell colors */
    td.gp { font-weight:700; text-align:center; }
    td.gp.positive { color:#2c9a3d; } /* green */
    td.gp.negative { color:#d23b3b; } /* red */
    td.gp.neutral { color:var(--muted); }

    /* tidy fonts */
    tbody td { font-size:13px; }
    tbody td.idx { font-size:13px; }

    /* small screens: allow horizontal scroll */
    @media (max-width:1100px){
      .container-main { padding: 0 12px; }
      table.rank-table { min-width: 1000px; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="index.html">PERFORMANCE BAN-TAN</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav me-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Rangking</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item active" href="ranking-household.html">Rangking Household</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container container-main">
    <div class="page-header">
      <img src="PERFORMANCE TEAM.png" alt="" style="height:42px;">
      <div>
        <div class="page-title">Ranking Household — RANKING HSA</div>
        <small class="text-muted">Header agent diputar vertikal supaya muat rapi</small>
      </div>
    </div>

    <div id="loading">Memuat data dari Google Sheets…</div>
    <div id="error" class="text-danger"></div>

    <div class="rank-wrapper d-none" id="rankWrap">
      <table class="rank-table" id="rankTable" aria-describedby="loading">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </main>

  <script>
    // CONFIG
    const SPREADSHEET_ID = '1nJ5FQ4A9sd4FsxRXuAMr42eHalnd0N2Rm7dK_05Filg';
    const SHEET_NAME = 'RANKING HSA';
    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json`;

    fetch(GVIZ_URL)
      .then(r => r.text())
      .then(text => {
        const jsonText = text.replace(/^[\s\S]*?setResponse\(|\);?\s*$/g, '');
        const data = JSON.parse(jsonText);
        renderVerticalHeaderTable(data.table);
      })
      .catch(err => {
        document.getElementById('loading').style.display = 'none';
        const e = document.getElementById('error');
        e.style.display = 'block';
        e.textContent = 'Gagal memuat sheet. Pastikan sheet dipublikasikan (Anyone with link can view). Error: ' + err.message;
      });

    function renderVerticalHeaderTable(table) {
      document.getElementById('loading').style.display = 'none';
      const cols = table.cols.map(c => c.label || c.id || '');
      const rows = table.rows || [];

      // determine start index (skip initial empty column if present)
      let startIdx = 0;
      while (startIdx < cols.length && (!cols[startIdx] || cols[startIdx].trim() === '')) startIdx++;
      const idxCol = startIdx;
      const targetCol = startIdx + 1;
      const agentColsStart = startIdx + 2;
      const agentNames = cols.slice(agentColsStart).map(s => s || '');

      // build thead: we will create 1 row whose agent th include rotated blocks
      const thead = document.getElementById('tableHead');
      thead.innerHTML = '';

      const topRow = document.createElement('tr');
      topRow.className = 'top-row';

      const thIndex = document.createElement('th');
      thIndex.className = 'idx';
      thIndex.rowSpan = 1;
      thIndex.textContent = 'INDEX';
      topRow.appendChild(thIndex);

      const thTarget = document.createElement('th');
      thTarget.className = 'target';
      thTarget.rowSpan = 1;
      thTarget.textContent = 'TARGET';
      topRow.appendChild(thTarget);

      // For each agent, create a th.agent containing rotated block with name (black) and Growth Point (blue)
      agentNames.forEach(name => {
        const th = document.createElement('th');
        th.className = 'agent';

        const rot = document.createElement('div');
        rot.className = 'rotated';

        // inner stacked block: name (black) and sub (blue)
        const nameBlock = document.createElement('div');
        nameBlock.className = 'name';
        nameBlock.style.width = '100%';
        nameBlock.innerHTML = `<span class="text">${(name||'').toUpperCase()}</span>`;

        const subBlock = document.createElement('div');
        subBlock.className = 'sub';
        subBlock.style.width = '100%';
        subBlock.innerHTML = `<span class="text">GROWTH POINT</span>`;

        // To make rotation consistent, we wrap both blocks into a single element and rotate the wrapper text
        // We'll create a container and inside put two stacked spans (but both will be rotated together)
        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex';
        wrapper.style.flexDirection = 'column';
        wrapper.style.alignItems = 'center';
        wrapper.style.justifyContent = 'center';
        wrapper.style.height = '100%';
        wrapper.style.width = '100%';

        // Create two small bars, but their inner text will be rotated via CSS by creating .text elements above.
        // Instead of rotating separate pieces, we'll simply put two spans rotated.
        const topText = document.createElement('span');
        topText.className = 'text';
        topText.style.background = 'var(--black)';
        topText.style.display = 'inline-block';
        topText.style.padding = '6px 8px';
        topText.style.color = '#fff';
        topText.style.fontWeight = '700';
        topText.textContent = (name || '').toUpperCase();

        const bottomText = document.createElement('span');
        bottomText.className = 'text';
        bottomText.style.background = 'var(--header-blue)';
        bottomText.style.display = 'inline-block';
        bottomText.style.padding = '4px 8px';
        bottomText.style.color = '#fff';
        bottomText.style.fontWeight = '600';
        bottomText.style.marginTop = '6px';
        bottomText.textContent = 'GROWTH POINT';

        // We'll rotate the wrapper which contains the two spans stacked vertically
        const rotatedWrapper = document.createElement('div');
        rotatedWrapper.style.transform = 'rotate(-90deg)';
        rotatedWrapper.style.transformOrigin = 'center';
        rotatedWrapper.style.display = 'flex';
        rotatedWrapper.style.flexDirection = 'column';
        rotatedWrapper.style.alignItems = 'center';
        rotatedWrapper.style.justifyContent = 'center';
        rotatedWrapper.appendChild(topText);
        rotatedWrapper.appendChild(bottomText);

        rot.appendChild(rotatedWrapper);
        th.appendChild(rot);
        topRow.appendChild(th);
      });

      thead.appendChild(topRow);

      // body
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      function isGroupHeader(row) {
        const c0 = row.c[idxCol];
        if (!c0 || !c0.v) return false;
        const v = ('' + c0.v).trim();
        if (!v) return false;
        const keywords = ['KPI', 'POINT RANKING', 'KPI B2C', 'KPI B2B', 'KPI 12 PI LATEN'];
        for (let k of keywords) if (v.toUpperCase().startsWith(k.toUpperCase())) return true;
        const otherPopulated = row.c.slice(idxCol+1).filter(x=>x && (x.v!==null && x.v!==undefined && x.v!== '')).length;
        if (otherPopulated <= 1 && v.length>0) return true;
        return false;
      }

      rows.forEach((r) => {
        if (isGroupHeader(r)) {
          const trg = document.createElement('tr');
          const tdg = document.createElement('td');
          tdg.colSpan = 2 + agentNames.length;
          tdg.className = 'group-header';
          tdg.textContent = (r.c[idxCol] && r.c[idxCol].v) ? r.c[idxCol].v : '';
          trg.appendChild(tdg);
          tbody.appendChild(trg);
          return;
        }

        const tr = document.createElement('tr');

        // INDEX
        const tdIdx = document.createElement('td');
        tdIdx.className = 'idx';
        const idxVal = (r.c[idxCol] && (r.c[idxCol].v !== null && r.c[idxCol].v !== undefined)) ? r.c[idxCol].v : (r.c[idxCol] && r.c[idxCol].f ? r.c[idxCol].f : '');
        tdIdx.textContent = idxVal || '';
        tr.appendChild(tdIdx);

        // TARGET
        const tdT = document.createElement('td');
        const tVal = (r.c[targetCol] && (r.c[targetCol].v !== null && r.c[targetCol].v !== undefined)) ? r.c[targetCol].v : (r.c[targetCol] && r.c[targetCol].f ? r.c[targetCol].f : '');
        if (String(tVal).toUpperCase().includes('TARGET') || String(tVal).trim() === '') {
          tdT.className = 'target cell-target';
        } else {
          tdT.className = 'target';
        }
        tdT.textContent = tVal || '';
        tr.appendChild(tdT);

        // agents
        for (let ci = agentColsStart; ci < agentColsStart + agentNames.length; ci++) {
          const cell = r.c[ci];
          let raw = '';
          if (cell) {
            if (cell.v !== null && cell.v !== undefined) raw = cell.v;
            else if (cell.f) raw = cell.f;
          }
          const td = document.createElement('td');
          td.className = 'agent'; // ensure width applied
          // numeric?
          if (typeof raw === 'number') {
            td.className += ' gp ' + (raw > 0 ? 'positive' : (raw < 0 ? 'negative' : 'neutral'));
            td.textContent = raw;
          } else {
            const m = ((''+raw).match(/-?\d+/) || [null])[0];
            if (m !== null && m !== undefined) {
              const num = parseInt(m,10);
              td.className += ' gp ' + (num > 0 ? 'positive' : (num < 0 ? 'negative' : 'neutral'));
              td.textContent = (''+raw).trim();
            } else {
              td.textContent = raw || '';
              td.style.textAlign = 'center';
            }
          }
          tr.appendChild(td);
        }

        tbody.appendChild(tr);
      });

      document.getElementById('rankWrap').classList.remove('d-none');
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
