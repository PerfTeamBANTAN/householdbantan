<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rangking Household — RANKING HSA</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --black:#0b0b0b;
      --header-blue:#2f6fb8;
      --target-red:#d94b4b;
      --green:#2c9a3d;
      --red:#d23b3b;
      --muted:#6b6b6b;
      --light-gray:#f7f7f7;
      --cell-border:#e6e6e6;
      --colA-w:40px;    /* bullet column (A) */
      --colB-w:220px; /* INDEX text column (B) */
      --colC-w:90px;  /* TARGET column (C) */
      --agent-min-w:60px; /* min width per agent subcol */
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #fff;
      color: #222;
      padding-top: 70px;
    }

    .container-main { max-width:1300px; margin:0 auto; }

    .page-header { display:flex; align-items:center; gap:12px; margin-bottom: 12px; }
    .page-title { font-weight:700; font-size:20px; }

    .rank-wrapper { overflow:auto; background:#fff; padding:12px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.04); }

    /* table layout fixed to maintain merge scheme */
    table.rank-table { border-collapse: collapse; width:100%; table-layout: fixed; min-width: 900px; }
    table.rank-table thead th, table.rank-table tbody td {
      border:1px solid var(--cell-border);
      vertical-align:middle;
      padding:8px 6px;
      font-size:13px;
      word-break:break-word;
    }

    /* left columns widths: A (bullet), B (INDEX text), C (TARGET) */
    th.col-bullet, td.col-bullet { width: var(--colA-w); min-width: var(--colA-w); max-width: var(--colA-w); text-align:center; background:#fff; }
    th.col-index, td.col-index { width: var(--colB-w); min-width: var(--colB-w); max-width: var(--colB-w); text-align:left; background:var(--light-gray); font-weight:700; padding:10px; }
    th.col-target, td.col-target { width: var(--colC-w); min-width: var(--colC-w); max-width: var(--colC-w); text-align:center; font-weight:700; }

    /* agent subcolumns: each group has 3 subcols; we set min width for each subcol */
    th.agent-sub, td.agent-sub { min-width: var(--agent-min-w); max-width: 160px; text-align:center; padding:8px; }

    /* header styles */
    thead tr.top th { background:var(--black); color:#fff; font-weight:700; font-size:12px; text-align:center; padding:10px 6px; }
    thead tr.sub th { background:var(--header-blue); color:#fff; font-weight:600; font-size:11px; text-align:center; padding:6px 6px; }

    .cell-target { background: var(--target-red); color:#fff; }

    .group-header {
      background: var(--black);
      color:#fff;
      font-weight:700;
      padding:8px 12px;
      text-align:left;
    }

    td.gp { font-weight:700; text-align:center; }
    td.gp.positive { color: var(--green); }
    td.gp.negative { color: var(--red); }
    td.gp.neutral { color: var(--muted); }

    td.idx-merged { background:var(--light-gray); font-weight:700; padding:10px; }

    @media (max-width: 900px) {
      .container-main { padding: 0 10px; }
      table.rank-table { min-width: 800px; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="index.html">PERFORMANCE BAN-TAN</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav me-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="racingDropdown" role="button" data-bs-toggle="dropdown">Rangking</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="ranking-household.html">Rangking Household</a></li>
              <li><a class="dropdown-item" href="#">Rangking B2C</a></li>
              <li><a class="dropdown-item" href="#">Rangking B2B</a></li>
            </ul>
          </li>

          <!-- KPI 12 PI LATEN -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="kpi12piDropdown" role="button" data-bs-toggle="dropdown">KPI 12 PI Laten</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">Dashboard 12 PI Laten</a></li>
              <li><a class="dropdown-item" href="#">Ranking PI Laten HSA</a></li>
              <li><a class="dropdown-item" href="#">Indikator Not ACH</a></li>
              <li><a class="dropdown-item" href="#">Improvement PI Laten</a></li>
              <li><a class="dropdown-item" href="timeline-tower.html">TimeLine Tower</a></li>
            </ul>
          </li>

          <!-- KPI B2C -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="kpiioanDropdown" role="button" data-bs-toggle="dropdown">KPI B2C</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">Dashboard B2C</a></li>
              <li><a class="dropdown-item" href="#">Ranking B2C HSA</a></li>
              <li><a class="dropdown-item" href="#">Ranking B2C Mitra</a></li>
              <li><a class="dropdown-item" href="#">Indikator Not ACH</a></li>
              <li><a class="dropdown-item" href="#">Improvement B2C</a></li>
            </ul>
          </li>

          <!-- KPI NON SEKTOR B2B -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="kpiB2BDropdown" role="button" data-bs-toggle="dropdown">KPI Non Sektor B2B</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">HSI</a></li>
              <li><a class="dropdown-item" href="#">DATIN</a></li>
              <li><a class="dropdown-item" href="#">WIFI</a></li>
              <li><a class="dropdown-item" href="#">OLO</a></li>
            </ul>
          </li>

          <!-- KPI WSA -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="kpiWSADropdown" role="button" data-bs-toggle="dropdown">KPI WSA</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">FFG</a></li>
              <li><a class="dropdown-item" href="#">TTI</a></li>
              <li><a class="dropdown-item" href="#">Service Availability</a></li>
              <li><a class="dropdown-item" href="#">Assurance Guarantee</a></li>
              <li><a class="dropdown-item" href="#">TTR</a></li>
            </ul>
          </li>

          <!-- KPI MAINTENANCE -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="kpiMTCDropdown" role="button" data-bs-toggle="dropdown">KPI Maintenance</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">FTM</a></li>
              <li><a class="dropdown-item" href="#">OLT</a></li>
              <li><a class="dropdown-item" href="#">GAMAS</a></li>
              <li><a class="dropdown-item" href="#">Pengawasan Project P3</a></li>
              <li><a class="dropdown-item" href="#">Patroli Akses</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <main class="container container-main">
    <div class="page-header">
      <img src="PERFORMANCE TEAM.png" alt="" style="height:42px;">
      <div>
        <div class="page-title">Ranking Household — RANKING HSA</div>
        <div class="small-note">INDEX digabung (A+B) dan semua teks di latar hitam berwarna putih</div>
      </div>
    </div>

    <div id="loading">Memuat data dari Google Sheets…</div>
    <div id="error" class="text-danger"></div>

    <div class="rank-wrapper d-none" id="rankWrap">
      <table class="rank-table" id="rankTable" aria-describedby="loading">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </main>

  <script>
    // CONFIG — sheet harus dipublikasikan / anyone with link can view
    const SPREADSHEET_ID = '1nJ5FQ4A9sd4FsxRXuAMr42eHalnd0N2Rm7dK_05Filg';
    const SHEET_NAME = 'RANKING HSA';
    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json`;

    // Rows that should have INDEX and TARGET merged (list dari Anda)
    const MERGE_INDEX_TARGET_ROWS = [
      'B2C CX CUSTOMER (Time to Repair)',
      'B2C CX CUSTOMER (Management)',
      'B2C Quality of Service Assurance',
      'B2C Quality of Alpro',
      'B2C Quality Data Service',
      'B2C Quality Control',
      'B2B CX CUSTOMER (Time to Repair)',
      'B2B CX CUSTOMER (Management)',
      'B2B Quality of Service Assurance'
    ].map(s => s.toUpperCase());

    // agent names order expected (used for header if detection fails)
    const AGENT_NAMES = ['YAYAT','EKA','VICKY','JAMAL','DADY','RISMAN','HERLANDO','DANANG','GUNTUR','YANTO'];

    fetch(GVIZ_URL)
      .then(r => r.text())
      .then(text => {
        const jsonText = text.replace(/^[\s\S]*?setResponse\(|\);?\s*$/g, '');
        const data = JSON.parse(jsonText);
        buildMergedTableAutoDetect(data.table);
      })
      .catch(err => {
        document.getElementById('loading').style.display = 'none';
        const e = document.getElementById('error');
        e.style.display = 'block';
        e.textContent = 'Gagal memuat sheet. Pastikan sheet dipublikasikan. Error: ' + err.message;
      });

    function buildMergedTableAutoDetect(table) {
      document.getElementById('loading').style.display = 'none';
      const cols = table.cols.map(c => (c && c.label) ? c.label.toString() : '');
      const rows = table.rows || [];

      // detect first non-empty column index (skip leading empties)
      let start = 0;
      while (start < cols.length && (!cols[start] || cols[start].trim() === '')) start++;

      const colUpper = cols.map(c => (c || '').toString().toUpperCase());

      // find agent positions by matching names, fallback to assumed layout
      const agentPositions = AGENT_NAMES.map((name, i) => {
        const found = colUpper.findIndex(c => c && c.includes(name));
        return found >= 0 ? found : null;
      });
      const fallbackAgentStart = start + 3; // D
      const fallbackPositions = AGENT_NAMES.map((_,i) => fallbackAgentStart + i*3);
      const finalAgentPositions = agentPositions.map((p,i) => p === null ? fallbackPositions[i] : p);

      const agentGroups = AGENT_NAMES.map((name,i) => ({ name, start: finalAgentPositions[i], span: 3 }));

      // columns mapping: A=start, B=start+1, C=start+2
      const idxCol = start;
      const idxTextCol = start + 1;
      const targetCol = start + 2;

      // Build THEAD: NOTE — INDEX merged across A+B here (colspan=2)
      const thead = document.getElementById('tableHead');
      thead.innerHTML = '';

      const top = document.createElement('tr');
      top.className = 'top';

      // INDEX as merged cell (colspan=2)
      const thIndexMerged = document.createElement('th');
      thIndexMerged.colSpan = 2;
      thIndexMerged.className = 'col-index black-cell';
      thIndexMerged.textContent = 'INDEX';
      top.appendChild(thIndexMerged);

      // TARGET keeps rowspan=2
      const thC = document.createElement('th');
      thC.className = 'col-target';
      thC.rowSpan = 2;
      thC.textContent = 'TARGET';
      top.appendChild(thC);

      // agent group headers
      agentGroups.forEach(g => {
        const th = document.createElement('th');
        th.colSpan = g.span;
        th.className = 'agent-sub black-cell'; // black header with white text
        th.textContent = g.name;
        top.appendChild(th);
      });
      thead.appendChild(top);

      // sub row: two placeholders (bullet & index text) because INDEX consumed 2 cols; then Growth Point per group
      const sub = document.createElement('tr');
      sub.className = 'sub';
      const phBullet = document.createElement('th'); phBullet.className = 'col-bullet'; phBullet.textContent = '';
      const phIdx = document.createElement('th'); phIdx.className = 'col-index'; phIdx.textContent = '';
      sub.appendChild(phBullet); sub.appendChild(phIdx);

      agentGroups.forEach(() => {
        const th = document.createElement('th');
        th.className = 'agent-sub';
        th.colSpan = 3;
        th.textContent = 'Growth Point';
        sub.appendChild(th);
      });
      thead.appendChild(sub);

      // BODY
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      function isGroupHeader(r) {
        const vObj = r.c[idxCol];
        const v = vObj && (vObj.v !== null && vObj.v !== undefined) ? (''+vObj.v).trim() : '';
        if (!v) return false;
        const keys = ['KPI','POINT RANKING','KPI B2C','KPI B2B','KPI 12 PI LATEN'];
        for (let k of keys) if (v.toUpperCase().startsWith(k.toUpperCase())) return true;
        return false;
      }

      rows.forEach(r => {
        if (isGroupHeader(r)) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          // compute total agent subcols
          const totalAgentSubcols = agentGroups.reduce((s,g)=>s + g.span,0);
          td.colSpan = 2 + 1 + totalAgentSubcols; // A+B + TARGET + agent subcols
          td.className = 'group-header';
          td.textContent = r.c[idxCol] && r.c[idxCol].v ? r.c[idxCol].v : '';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        const tr = document.createElement('tr');

        // A: bullet
        const tdA = document.createElement('td'); tdA.className = 'col-bullet'; tdA.textContent = '▪️';
        tr.appendChild(tdA);

        // B: index text (may be merged with C)
        const idxObj = r.c[idxTextCol];
        const idxText = idxObj && (idxObj.v !== null && idxObj.v !== undefined) ? (''+idxObj.v).trim() : (idxObj && idxObj.f ? ''+idxObj.f : '');

        const tObj = r.c[targetCol];
        const tText = tObj && (tObj.v !== null && tObj.v !== undefined) ? tObj.v : (tObj && tObj.f ? tObj.f : '');

        if (MERGE_INDEX_TARGET_ROWS.includes((idxText||'').toUpperCase())) {
          const tdMerge = document.createElement('td');
          tdMerge.colSpan = 2;
          tdMerge.className = 'idx-merged';
          tdMerge.textContent = idxText || '';
          tr.appendChild(tdMerge);
        } else {
          const tdB = document.createElement('td'); tdB.className = 'col-index'; tdB.textContent = idxText || '';
          tr.appendChild(tdB);

          const tdC = document.createElement('td'); tdC.className = 'col-target';
          tdC.textContent = (tText!==undefined && tText!==null) ? tText : '';
          if (!tText || (''+tText).toUpperCase().includes('TARGET')) tdC.classList.add('cell-target');
          tr.appendChild(tdC);
        }

        // agent groups: find first non-empty value inside group's sheet columns and place it in middle subcol
        agentGroups.forEach(g => {
          let foundVal = null;
          for (let k=0;k<g.span;k++) {
            const sheetIdx = g.start + k;
            const cellObj = r.c[sheetIdx];
            let raw = '';
            if (cellObj) {
              if (cellObj.v !== null && cellObj.v !== undefined) raw = cellObj.v;
              else if (cellObj.f) raw = cellObj.f;
            }
            if ((raw !== '' && raw !== null && raw !== undefined) && foundVal === null) {
              foundVal = raw;
            }
          }

          // create 3 subcells; put foundVal in middle one
          for (let k=0;k<g.span;k++) {
            const td = document.createElement('td');
            td.className = 'agent-sub';
            if (k===1 && foundVal !== null) {
              if (typeof foundVal === 'number') {
                td.classList.add('gp');
                td.classList.add(foundVal>0? 'positive' : (foundVal<0? 'negative':'neutral'));
                td.textContent = foundVal;
              } else {
                const m = ((''+foundVal).match(/-?\d+/) || [null])[0];
                if (m !== null && m !== undefined) {
                  const n = parseInt(m,10);
                  td.classList.add('gp');
                  td.classList.add(n>0? 'positive' : (n<0? 'negative' : 'neutral'));
                  td.textContent = (''+foundVal).trim();
                } else {
                  td.textContent = ''+foundVal;
                }
              }
            }
            tr.appendChild(td);
          }
        });

        tbody.appendChild(tr);
      });

      document.getElementById('rankWrap').classList.remove('d-none');
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
