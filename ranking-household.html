<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rangking Household — RANKING HSA</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --black:#0b0b0b;
      --header-blue:#2f6fb8;
      --target-red:#d94b4b;
      --green:#2c9a3d;
      --red:#d23b3b;
      --muted:#6b6b6b;
      --light-gray:#f7f7f7;
      --cell-border:#e6e6e6;
      --idx-w:40px;    /* bullet column (A) */
      --idx-text-w:220px; /* INDEX text column (B) */
      --target-w:90px;  /* TARGET column (C) */
      --agent-min-w:60px; /* min width per agent subcol */
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #fff;
      color: #222;
      padding-top: 70px;
    }

    .container-main { max-width:1300px; margin:0 auto; }

    .page-header { display:flex; align-items:center; gap:12px; margin-bottom: 12px; }
    .page-title { font-weight:700; font-size:20px; }

    .rank-wrapper { overflow:auto; background:#fff; padding:12px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.04); }

    /* table layout fixed to maintain merge scheme */
    table.rank-table { border-collapse: collapse; width:100%; table-layout: fixed; min-width: 900px; }
    table.rank-table thead th, table.rank-table tbody td {
      border:1px solid var(--cell-border);
      vertical-align:middle;
      padding:8px 6px;
      font-size:13px;
    }

    /* left columns widths: A (bullet), B (INDEX text), C (TARGET) */
    th.col-bullet, td.col-bullet { width: var(--idx-w); min-width: var(--idx-w); max-width: var(--idx-w); text-align:center; background:#fff; }
    th.col-index, td.col-index { width: var(--idx-text-w); min-width: var(--idx-text-w); max-width: var(--idx-text-w); text-align:left; background:var(--light-gray); font-weight:700; padding:10px; }
    th.col-target, td.col-target { width: var(--target-w); min-width: var(--target-w); max-width: var(--target-w); text-align:center; font-weight:700; }

    /* agent subcolumns: each group has 3 subcols; we set min width for each subcol */
    th.agent-sub, td.agent-sub { min-width: var(--agent-min-w); max-width: 160px; text-align:center; padding:8px; word-break:break-word; }

    /* header styles */
    thead tr.top th { background:var(--black); color:#fff; font-weight:700; font-size:12px; text-align:center; padding:10px 6px; }
    thead tr.sub th { background:var(--header-blue); color:#fff; font-weight:600; font-size:11px; text-align:center; padding:6px 6px; }

    .cell-target { background: var(--target-red); color:#fff; }

    .group-header {
      background: var(--black);
      color:#fff;
      font-weight:700;
      padding:8px 12px;
      text-align:left;
    }

    td.gp { font-weight:700; text-align:center; }
    td.gp.positive { color: var(--green); }
    td.gp.negative { color: var(--red); }
    td.gp.neutral { color: var(--muted); }

    /* merged index-target style (when we set colspan=2) */
    td.idx-merged { background:var(--light-gray); font-weight:700; padding:10px; }

    @media (max-width: 900px) {
      .container-main { padding: 0 10px; }
      table.rank-table { min-width: 800px; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="index.html">PERFORMANCE BAN-TAN</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav me-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Rangking</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item active" href="ranking-household.html">Rangking Household</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container container-main">
    <div class="page-header">
      <img src="PERFORMANCE TEAM.png" alt="" style="height:42px;">
      <div>
        <div class="page-title">Ranking Household — RANKING HSA</div>
        <div class="small-note">Meniru merge kolom: A:B=INDEX, C=TARGET, D:F=YAYAT, ... (lihat instruksi)</div>
      </div>
    </div>

    <div id="loading">Memuat data dari Google Sheets…</div>
    <div id="error" class="text-danger"></div>

    <div class="rank-wrapper d-none" id="rankWrap">
      <table class="rank-table" id="rankTable" aria-describedby="loading">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </main>

  <script>
    // CONFIG — pastikan sheet dipublikasikan / anyone with link can view
    const SPREADSHEET_ID = '1nJ5FQ4A9sd4FsxRXuAMr42eHalnd0N2Rm7dK_05Filg';
    const SHEET_NAME = 'RANKING HSA';
    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json`;

    // Rows for which INDEX and TARGET must be merged (B:C merged) — from your list
    const MERGE_INDEX_TARGET_ROWS = [
      'B2C CX CUSTOMER (Time to Repair)',
      'B2C CX CUSTOMER (Management)',
      'B2C Quality of Service Assurance',
      'B2C Quality of Alpro',
      'B2C Quality Data Service',
      'B2C Quality Control',
      'B2B CX CUSTOMER (Time to Repair)',
      'B2B CX CUSTOMER (Management)',
      'B2B Quality of Service Assurance'
    ];

    fetch(GVIZ_URL)
      .then(r => r.text())
      .then(text => {
        const jsonText = text.replace(/^[\s\S]*?setResponse\(|\);?\s*$/g, '');
        const data = JSON.parse(jsonText);
        buildMergedTable(data.table);
      })
      .catch(err => {
        document.getElementById('loading').style.display = 'none';
        const e = document.getElementById('error');
        e.style.display = 'block';
        e.textContent = 'Gagal memuat sheet. Pastikan sheet dipublikasikan. Error: ' + err.message;
      });

    function buildMergedTable(table) {
      document.getElementById('loading').style.display = 'none';
      const cols = table.cols.map(c => c.label || c.id || '');
      const rows = table.rows || [];

      // mapping from user: A:B = INDEX ; C = TARGET ; D:F = YAYAT ; G:I = EKA ; J:L = VICKY ; M:O = JAMAL ; P:R = DADY ; S:U = RISMAN ; V:X = HERLANDO ; Y:AA = DANANG ; AB:AD = GUNTUR ; AF:AH = YANTO
      // We'll detect start index skipping empty leading columns
      let start = 0;
      while (start < cols.length && (!cols[start] || cols[start].trim() === '')) start++;

      const idxCol = start;           // A
      const idxTextCol = start + 1;   // B
      const targetCol = start + 2;    // C
      const agentGroups = [
        {name: 'YAYAT', start: start + 3, span:3}, // D:F
        {name: 'EKA',  start: start + 6, span:3}, // G:I
        {name: 'VICKY',start: start + 9, span:3}, // J:L
        {name: 'JAMAL',start: start + 12, span:3}, // M:O
        {name: 'DADY', start: start + 15, span:3}, // P:R
        {name: 'RISMAN',start: start + 18, span:3}, // S:U
        {name: 'HERLANDO',start: start + 21, span:3}, // V:X
        {name: 'DANANG',start: start + 24, span:3}, // Y:AA
        {name: 'GUNTUR',start: start + 27, span:3}, // AB:AD
        {name: 'YANTO',start: start + 30, span:3} // AF:AH
      ];

      // Build THEAD: top row (INDEX colspan=2, TARGET rowspan=2, agent name colspan=3)
      const thead = document.getElementById('tableHead');
      thead.innerHTML = '';

      const top = document.createElement('tr'); top.className = 'top';
      const thIndex = document.createElement('th'); thIndex.colSpan = 2; thIndex.className = 'col-index'; thIndex.textContent = 'INDEX';
      const thTarget = document.createElement('th'); thTarget.rowSpan = 2; thTarget.className = 'col-target'; thTarget.textContent = 'TARGET';
      top.appendChild(thIndex); top.appendChild(thTarget);

      // add agent groups
      agentGroups.forEach(g => {
        const th = document.createElement('th');
        th.colSpan = g.span;
        th.className = 'agent-sub';
        th.textContent = g.name;
        top.appendChild(th);
      });
      thead.appendChild(top);

      // sub header row: for the INDEX colspan=2 we must add two th placeholders (bullet + index text)
      const sub = document.createElement('tr'); sub.className = 'sub';
      const thBullet = document.createElement('th'); thBullet.className = 'col-bullet'; thBullet.textContent = ''; // bullet column header empty
      const thIdxText = document.createElement('th'); thIdxText.className = 'col-index'; thIdxText.textContent = ''; // left blank; content appears in body
      sub.appendChild(thBullet); sub.appendChild(thIdxText);
      // for each agent group, create a single th spanning group.span and label "Growth Point"
      agentGroups.forEach(g => {
        const th = document.createElement('th'); th.colSpan = g.span; th.className = 'agent-sub'; th.textContent = 'Growth Point';
        sub.appendChild(th);
      });
      thead.appendChild(sub);

      // Build BODY
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      // helper detect group header rows like 'KPI B2C' or 'KPI B2B'
      function isGroupHeader(r) {
        const v = r.c[idxCol] && (r.c[idxCol].v !== null && r.c[idxCol].v !== undefined) ? (''+r.c[idxCol].v).trim() : '';
        if (!v) return false;
        const keys = ['KPI','POINT RANKING','KPI B2C','KPI B2B','KPI 12 PI LATEN'];
        for (let k of keys) if (v.toUpperCase().startsWith(k.toUpperCase())) return true;
        return false;
      }

      rows.forEach(r => {
        if (isGroupHeader(r)) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 2 + 1 + agentGroups.reduce((a,b)=>a+b.span,0); // 2 idx + target + all agent subcols
          td.className = 'group-header';
          td.textContent = r.c[idxCol] && r.c[idxCol].v ? r.c[idxCol].v : '';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        const tr = document.createElement('tr');

        // COL A: bullet (small square)
        const tdBullet = document.createElement('td'); tdBullet.className = 'col-bullet';
        // If first IDX cell not empty but equal to bullet marker or special, show bullet; else if index text present show bullet char
        tdBullet.textContent = '▪️';
        tr.appendChild(tdBullet);

        // INDEX text in B
        const idxTextRaw = r.c[idxTextCol] && (r.c[idxTextCol].v !== null && r.c[idxTextCol].v !== undefined) ? r.c[idxTextCol].v : (r.c[idxTextCol] && r.c[idxTextCol].f ? r.c[idxTextCol].f : '');
        const idxText = (''+ (idxTextRaw || '') ).trim();

        // TARGET raw (C)
        const tRaw = r.c[targetCol] && (r.c[targetCol].v !== null && r.c[targetCol].v !== undefined) ? r.c[targetCol].v : (r.c[targetCol] && r.c[targetCol].f ? r.c[targetCol].f : '');
        const tText = (''+(tRaw||'')).trim();

        // If this index row should be merged across B:C (INDEX text + TARGET merged), create one td with colspan=2 and skip separate target cell
        if (MERGE_INDEX_TARGET_ROWS.includes(idxText)) {
          const tdMerge = document.createElement('td');
          tdMerge.colSpan = 2;
          tdMerge.className = 'idx-merged';
          tdMerge.textContent = idxText;
          tr.appendChild(tdMerge);
        } else {
          // normal: create INDEX cell and TARGET cell separately
          const tdIdx = document.createElement('td'); tdIdx.className = 'col-index';
          tdIdx.textContent = idxText;
          tr.appendChild(tdIdx);

          const tdTarget = document.createElement('td'); tdTarget.className = 'col-target';
          tdTarget.textContent = tText;
          // style TARGET red if it contains 'TARGET' text or empty as in original sheet — keep heuristic
          if (!tText || String(tText).toUpperCase().includes('TARGET')) {
            tdTarget.classList.add('cell-target');
          }
          tr.appendChild(tdTarget);
        }

        // For each agent group (each has 3 subcols), we will fill the middle subcol with value (if present), leaving left & right empty for spacing (reproducing sheet)
        agentGroups.forEach(g => {
          const subCells = [];
          for (let k = 0; k < g.span; k++) {
            const td = document.createElement('td');
            td.className = 'agent-sub';
            // compute which column index this maps to in sheet: g.start + k
            const sheetColIdx = g.start + k;
            // get raw value
            const valObj = r.c[sheetColIdx];
            let raw = '';
            if (valObj) {
              if (valObj.v !== null && valObj.v !== undefined) raw = valObj.v;
              else if (valObj.f) raw = valObj.f;
            }
            // We only show the value in the middle subcol (k === 1). For other subcols keep blank to mimic spacing.
            if (k === 1) {
              // format numeric & color
              if (typeof raw === 'number') {
                td.classList.add('gp');
                td.classList.add(raw > 0 ? 'positive' : (raw < 0 ? 'negative' : 'neutral'));
                td.textContent = raw;
              } else {
                const m = ((''+raw).match(/-?\d+/) || [null])[0];
                if (m !== null && m !== undefined) {
                  const n = parseInt(m,10);
                  td.classList.add('gp');
                  td.classList.add(n > 0 ? 'positive' : (n < 0 ? 'negative' : 'neutral'));
                  td.textContent = (''+raw).trim();
                } else {
                  td.textContent = (raw || '');
                }
              }
            }
            subCells.push(td);
          }
          // append the group's subcells (left, middle, right)
          subCells.forEach(td => tr.appendChild(td));
        });

        tbody.appendChild(tr);
      });

      // show table
      document.getElementById('rankWrap').classList.remove('d-none');
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
