<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ranking Household — RANKING HSA</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --black:#0b0b0b;
      --header-blue:#2f6fb8;
      --target-red:#d94b4b;
      --green:#2c9a3d;
      --red:#d23b3b;
      --muted:#6b6b6b;
      --light-gray:#f7f7f7;
      --cell-border:#e6e6e6;
      --positive-3:#2ecc71;
      --positive-2:#5dade2;
      --positive-1:#f7dc6f;
      --neg-1:#f39c12;
      --neg-2:#f1948a;
      --neg-3:#e74c3c;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #fff;
      color: #222;
      padding-top: 72px;
      margin: 0;
    }

    .container-main { max-width:1300px; margin:0 auto; padding:18px; }

    .page-header { display:flex; align-items:flex-start; gap:12px; margin-bottom: 12px; }
    .page-title { font-weight:700; font-size:20px; }

    .small-note-box {
      background:#fff;
      border-left:4px solid var(--header-blue);
      padding:10px 14px;
      border-radius:6px;
      box-shadow:0 1px 6px rgba(0,0,0,0.04);
      margin-top:6px;
      font-size:13px;
    }

    .rank-wrapper {
      overflow:auto;
      background:#fff;
      padding:12px;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.04);
      margin-top:12px;
    }

    table.rank-table { border-collapse: collapse; width:100%; min-width:1200px; font-size:13px; }
    table.rank-table thead th, table.rank-table tbody td {
      border:1px solid var(--cell-border);
      vertical-align:middle;
      padding:8px 6px;
      word-break:break-word;
      text-align:center;
      white-space:nowrap;
    }

    thead tr.top th { background:var(--black); color:#fff; font-weight:700; font-size:12px; padding:10px 6px; }
    thead tr.sub th { background:var(--header-blue); color:#fff; font-weight:600; font-size:11px; padding:6px 6px; }

    .col-bullet { width:40px; min-width:40px; max-width:40px; background:#fff; }
    .col-index, .idx-merged { width:260px; min-width:220px; text-align:left; background:var(--light-gray); font-weight:700; padding:10px; }
    .col-target { width:90px; min-width:90px; font-weight:700; }

    .agent-sub { min-width:60px; padding:8px; }

    .black-cell { background:var(--black) !important; color:#fff !important; }
    .group-header { background:var(--black); color:#fff; font-weight:700; padding:8px 12px; text-align:left; }

    .gp { font-weight:700; padding:4px 6px; border-radius:4px; display:inline-block; min-width:28px; }
    .gp-3 { background:var(--positive-3); color:#fff; }
    .gp-2 { background:var(--positive-2); color:#fff; }
    .gp-1 { background:var(--positive-1); color:#000; }
    .gp0  { background:#e9ecef; color:#000; }
    .gp--1 { background:var(--neg-1); color:#fff; }
    .gp--2 { background:var(--neg-2); color:#fff; }
    .gp--3 { background:var(--neg-3); color:#fff; }

    tbody tr:nth-child(even) td { background:#fbfbfb; }
    tbody tr:hover td { background:#eef7ff; }

    .text-left { text-align:left !important; }

    @media (max-width: 900px) {
      .container-main { padding:10px; }
      table.rank-table { min-width:1000px; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html" style="display:flex;align-items:center">
        <img src="PERFORMANCE TEAM.png" alt="Logo" style="height:40px;margin-right:10px">PERFORMANCE BAN-TAN
      </a>
    </div>
  </nav>

  <main class="container-main">
    <div class="page-header">
      <img src="PERFORMANCE TEAM.png" alt="" style="height:42px;">
      <div style="flex:1">
        <div class="page-title">Ranking Household — RANKING HSA</div>
        <div class="small-note-box" role="note" aria-label="Keterangan Perhitungan Point">
          <div style="font-weight:700;margin-bottom:6px">Ket — Perhitungan Point</div>
          <ul style="margin:0 0 0 18px;padding:0">
            <li>▪️ Indikator pada H-1 tidak tercapai terhadap target dan growth sama terhadap H-2 : -2</li>
            <li>▪️ Indikator pada H-1 tidak tercapai terhadap target dan growth positif terhadap H-2 : -1</li>
            <li>▪️ Indikator pada H-1 tidak tercapai terhadap target dan growth negatif terhadap H-2 : -3</li>
            <li>▪️ Indikator pada H-1 tercapai terhadap target dan growth sama terhadap H-2 : 2</li>
            <li>▪️ Indikator pada H-1 tercapai terhadap target dan growth negatif terhadap H-2 : 1</li>
            <li>▪️ Indikator pada H-1 tercapai terhadap target dan growth positif terhadap H-2 : 3</li>
          </ul>
        </div>
      </div>
    </div>

    <div id="loading">Memuat data dari Google Sheets…</div>
    <div id="error" class="text-danger" style="display:none;"></div>

    <div class="rank-wrapper d-none" id="rankWrap">
      <table class="rank-table" id="rankTable" aria-describedby="loading">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </main>

  <script>
    // gunakan GVIZ URL yang kamu minta:
    const SPREADSHEET_ID = '1nJ5FQ4A9sd4FsxRXuAMr42eHalnd0N2Rm7dK_05Filg';
    const SHEET_NAME = 'RANKING HSA';
    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json`;

    // baris yang harus di-merge B:C ketika isi INDEX
    const MERGE_INDEX_TARGET_ROWS = [
      'B2C CX CUSTOMER (Time to Repair)',
      'B2C CX CUSTOMER (Management)',
      'B2C Quality of Service Assurance',
      'B2C Quality of Alpro',
      'B2C Quality Data Service',
      'B2C Quality Control',
      'B2B CX CUSTOMER (Time to Repair)',
      'B2B CX CUSTOMER (Management)',
      'B2B Quality of Service Assurance'
    ].map(s => s.toUpperCase());

    const GROUP_HEADERS = ['KPI B2C','KPI B2B','POINT RANKING'];
    const AGENT_NAMES = ['YAYAT','EKA','VICKY','ELRI','DADY','RISMAN','HERLANDO','DANANG','GUNTUR','YANTO'];

    fetch(GVIZ_URL)
      .then(r => r.text())
      .then(text => {
        const jsonText = text.replace(/^[\s\S]*?setResponse\(|\);?\s*$/g, '');
        const data = JSON.parse(jsonText);
        buildTableFromGviz(data.table);
      })
      .catch(err => {
        document.getElementById('loading').style.display = 'none';
        const e = document.getElementById('error');
        e.style.display = 'block';
        e.textContent = 'Gagal memuat sheet. Pastikan sheet dipublikasikan. Error: ' + err.message;
      });

    function buildTableFromGviz(table) {
      document.getElementById('loading').style.display = 'none';
      const cols = table.cols.map(c => (c && c.label) ? c.label.toString() : '');
      const rows = table.rows || [];

      // cari start kolom (skip leading empty cols)
      let start = 0;
      while (start < cols.length && (!cols[start] || cols[start].trim() === '')) start++;

      const colUpper = cols.map(c => (c || '').toString().toUpperCase());
      const agentPositions = AGENT_NAMES.map(name => {
        const idx = colUpper.findIndex(c => c && c.includes(name));
        return idx >= 0 ? idx : null;
      });
      const fallbackStart = start + 3;
      const fallbackPositions = AGENT_NAMES.map((_,i) => fallbackStart + i*3);
      const finalAgentPositions = agentPositions.map((p,i) => p === null ? fallbackPositions[i] : p);

      const agentGroups = AGENT_NAMES.map((name,i) => ({ name, start: finalAgentPositions[i], span: 3 }));
      const idxCol = start;         // kolom A (label kiri)
      const idxTextCol = start + 1; // kolom B (index text)
      const targetCol = start + 2;  // kolom C (target)

      // build header
      const thead = document.getElementById('tableHead'); thead.innerHTML = '';
      const top = document.createElement('tr'); top.className = 'top';

      const thIndex = document.createElement('th');
      thIndex.className = 'col-index black-cell';
      thIndex.colSpan = 2; thIndex.rowSpan = 2; thIndex.textContent = 'INDEX';
      top.appendChild(thIndex);

      const thTarget = document.createElement('th');
      thTarget.className = 'col-target black-cell';
      thTarget.rowSpan = 2; thTarget.textContent = 'TARGET';
      top.appendChild(thTarget);

      agentGroups.forEach(g => {
        const th = document.createElement('th'); th.colSpan = g.span; th.className = 'agent-sub black-cell'; th.textContent = g.name;
        top.appendChild(th);
      });
      thead.appendChild(top);

      const sub = document.createElement('tr'); sub.className = 'sub';
      agentGroups.forEach(() => {
        const th = document.createElement('th'); th.className = 'agent-sub'; th.colSpan = 3; th.textContent = 'Growth Point'; sub.appendChild(th);
      });
      thead.appendChild(sub);

      // body
      const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';

      function isGroupHeaderText(v) {
        if (!v) return false;
        return GROUP_HEADERS.some(k => v.toString().trim().toUpperCase() === k.toUpperCase());
      }

      rows.forEach(r => {
        const leftObj = r.c[idxCol];
        const leftText = leftObj && (leftObj.v !== null && leftObj.v !== undefined) ? (''+leftObj.v).trim() : (leftObj && leftObj.f ? ''+leftObj.f : '');
        const leftUpper = (leftText || '').toUpperCase();

        // collect values for agent groups (first non-empty cell within each group's 3 cols)
        const foundVals = agentGroups.map(g => {
          let v = null;
          for (let k=0;k<g.span;k++){
            const sheetIdx = g.start + k;
            const cellObj = r.c[sheetIdx];
            let raw = '';
            if (cellObj) {
              if (cellObj.v !== null && cellObj.v !== undefined) raw = cellObj.v;
              else if (cellObj.f) raw = cellObj.f;
            }
            if ((raw !== '' && raw !== null && raw !== undefined) && v === null) v = raw;
          }
          return v;
        });

        const anyAgentValue = foundVals.some(x => x !== null && x !== undefined && (''+x).trim() !== '');

        // handle special KPI 12 PI LATEN row (merged A:B black, but still show agent values if any)
        if (leftUpper === 'KPI 12 PI LATEN') {
          const tr = document.createElement('tr');

          const tdMerge = document.createElement('td'); tdMerge.colSpan = 2; tdMerge.className = 'black-cell'; tdMerge.textContent = leftText || 'KPI 12 PI LATEN';
          tr.appendChild(tdMerge);

          const tObj = r.c[targetCol];
          const tText = tObj && (tObj.v !== null && tObj.v !== undefined) ? tObj.v : (tObj && tObj.f ? tObj.f : '');
          const tdTarget = document.createElement('td'); tdTarget.className = 'col-target'; tdTarget.textContent = (tText!==undefined && tText!==null)? tText : '';
          if (!tText || (''+tText).toUpperCase().includes('TARGET')) tdTarget.classList.add('cell-target');
          tr.appendChild(tdTarget);

          agentGroups.forEach((g,i) => {
            for (let k=0;k<g.span;k++){
              const td = document.createElement('td'); td.className = 'agent-sub';
              if (k===1 && foundVals[i] !== null && foundVals[i] !== undefined && (''+foundVals[i]).trim() !== '') {
                putValueInTd(td, foundVals[i]);
              }
              tr.appendChild(td);
            }
          });

          tbody.appendChild(tr);
          return;
        }

        // if exact group header and no agent values -> full-width group header row
        if (isGroupHeaderText(leftText) && !anyAgentValue) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          const totalAgentSubcols = agentGroups.reduce((s,g)=>s+g.span,0);
          td.colSpan = 2 + 1 + totalAgentSubcols; // A+B + target + agents
          td.className = 'group-header';
          td.textContent = leftText || '';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        // otherwise normal row
        const tr = document.createElement('tr');

        if (isGroupHeaderText(leftText)) {
          // show merged A:B black with label
          const tdMerge = document.createElement('td'); tdMerge.colSpan = 2; tdMerge.className = 'black-cell'; tdMerge.textContent = leftText || '';
          tr.appendChild(tdMerge);
        } else {
          // bullet A
          const tdA = document.createElement('td'); tdA.className = 'col-bullet'; tdA.textContent = '▪️'; tr.appendChild(tdA);

          // index text B and target C (with optional merge)
          const idxObj = r.c[idxTextCol];
          const idxText = idxObj && (idxObj.v !== null && idxObj.v !== undefined) ? (''+idxObj.v).trim() : (idxObj && idxObj.f ? ''+idxObj.f : '');
          const tObj = r.c[targetCol];
          const tText = tObj && (tObj.v !== null && tObj.v !== undefined) ? tObj.v : (tObj && tObj.f ? tObj.f : '');

          if (MERGE_INDEX_TARGET_ROWS.includes((idxText||'').toUpperCase())) {
            const tdMerge = document.createElement('td'); tdMerge.colSpan = 2; tdMerge.className = 'idx-merged'; tdMerge.textContent = idxText || ''; tr.appendChild(tdMerge);
          } else {
            const tdB = document.createElement('td'); tdB.className = 'col-index'; tdB.textContent = idxText || ''; tr.appendChild(tdB);
            const tdC = document.createElement('td'); tdC.className = 'col-target'; tdC.textContent = (tText!==undefined && tText!==null) ? tText : ''; if (!tText || (''+tText).toUpperCase().includes('TARGET')) tdC.classList.add('cell-target'); tr.appendChild(tdC);
          }
        }

        // append agent groups
        agentGroups.forEach((g,i) => {
          for (let k=0;k<g.span;k++){
            const td = document.createElement('td'); td.className = 'agent-sub';
            if (k===1 && foundVals[i] !== null && foundVals[i] !== undefined && (''+foundVals[i]).trim() !== '') {
              putValueInTd(td, foundVals[i]);
            }
            tr.appendChild(td);
          }
        });

        tbody.appendChild(tr);
      });

      document.getElementById('rankWrap').classList.remove('d-none');
    }

    // helper: put numeric/text into td and style GP when numeric
    function putValueInTd(td, val) {
      const s = (''+val).trim();
      // detect integer like -3, 2, 1 etc (GP values are usually small ints)
      const m = s.match(/^(-?\d+)$/);
      if (m) {
        const n = parseInt(m[1],10);
        const span = document.createElement('span');
        span.className = 'gp ' + gpClassName(n);
        span.textContent = n;
        td.appendChild(span);
      } else {
        // fallback - put raw string
        td.textContent = s;
      }
    }

    function gpClassName(n) {
      if (n === 3) return 'gp-3';
      if (n === 2) return 'gp-2';
      if (n === 1) return 'gp-1';
      if (n === 0) return 'gp0';
      if (n === -1) return 'gp--1';
      if (n === -2) return 'gp--2';
      if (n === -3) return 'gp--3';
      // other numbers fall back to neutral
      return 'gp0';
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
