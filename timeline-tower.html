<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TimeLine Tower - CSV â†’ Gantt (fixed)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    body { font-family: "Segoe UI", Arial; background:#f7f7f8; padding-top:80px; }
    .chart-card { max-width:1250px; margin:20px auto; padding:20px; background:#fff; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.05); }
    #chart_div { height:700px; width:100%; min-height:300px; }
    .small-muted { color:#6c757d; font-size:0.9rem; }
    pre.debug { max-height:220px; overflow:auto; background:#f1f1f1; padding:10px; border-radius:6px; display:none; }
    table.preview { width:100%; border-collapse:collapse; font-size:13px; min-width:1200px; }
    table.preview th, table.preview td { border:1px solid #eee; padding:6px 8px; text-align:left; white-space:nowrap; }
    .preview-wrap { overflow:auto; max-height:260px; border:1px solid #f0f0f0; border-radius:6px; padding:6px; background:#fff; }
    .warning-box { background:#fff3cd; border:1px solid #ffeeba; color:#856404; padding:8px 12px; border-radius:6px; margin-bottom:12px; display:flex; align-items:center; gap:10px; }
    .warning-close { margin-left:auto; cursor:pointer; }
    .controls { min-width:460px; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">PERFORMANCE BAN-TAN</a>
    <div class="ms-auto small-muted">TimeLine Tower</div>
  </div>
</nav>

<div class="chart-card">
  <div class="d-flex align-items-start justify-content-between mb-3">
    <div>
      <h4 class="mb-0">ðŸ“Š Dashboard Tracking Order â€“ TimeLine Tower</h4>
      <div class="small-muted">Sumber: Google Sheet (CSV publik)</div>
    </div>

    <div class="d-flex gap-2 controls">
      <input id="searchInput" class="form-control" type="text" placeholder="Cari Task, Ticket, Nama Tower...">
      <select id="statusFilter" class="form-select" style="max-width:180px;">
        <option value="all">Semua status</option>
        <option value="inprogress">&lt;100% (In progress)</option>
        <option value="completed">100% (Completed)</option>
      </select>
      <button id="btnSearch" class="btn btn-primary">Cari</button>
      <button id="btnToggleDebug" class="btn btn-outline-secondary">Show debug</button>
    </div>
  </div>

  <!-- warnings area (non-blocking) -->
  <div id="warningsArea" style="display:none; margin-bottom:12px;"></div>

  <div id="chart_div">Memuat chartâ€¦</div>

  <hr/>
  <div class="mb-2"><strong>Preview data (10 baris pertama)</strong></div>
  <div id="preview_table" class="preview-wrap"></div>

  <div class="mt-3">
    <strong>Debug:</strong>
    <pre id="debug" class="debug"></pre>
  </div>
</div>

<script>
/*
  Perubahan penting:
  - Jika row punya start tapi tidak punya end -> gunakan end = start + 1 hari (24h)
  - Jika row punya end tapi tidak punya start -> gunakan start = end - 1 hari
  - Jika tidak punya keduanya -> skip
  - Preview disesuaikan agar scroll horizontal & vertical
  - Debug disembunyikan default, ada toggle
*/

const PUB_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcHZK2xNVK-lRfq_MnNF7MK_4x1iUQJL4ECSf7bBL51Yf7yHdbmGgv5RwtD0RZC6NULyTW7h3-E3o1/pub?gid=1842046587&single=true&output=csv';
const DEBUG = true;

google.charts.load('current', {'packages':['gantt']});
google.charts.setOnLoadCallback(init);

document.getElementById('btnSearch').addEventListener('click', applyFilters);
document.getElementById('btnToggleDebug').addEventListener('click', toggleDebug);

let headers = [];
let rows = [];
let warnings = [];

function logDebug(txt) {
  if (!DEBUG) return;
  const el = document.getElementById('debug');
  el.textContent += txt + '\n';
  console.info(txt);
}
function showMessage(txt) { logDebug('MSG: ' + txt); }

function showWarnings() {
  const area = document.getElementById('warningsArea');
  if (!warnings || warnings.length === 0) { area.style.display='none'; area.innerHTML=''; return; }
  area.style.display='block';
  area.innerHTML = '<div class="warning-box"><strong>Warning:</strong><div style="margin-left:8px;">' +
    warnings.map(w => '<div>' + escapeHtml(w) + '</div>').join('') +
    '</div><div class="warning-close btn btn-sm btn-outline-secondary" onclick="dismissWarnings()">Close</div></div>';
}
function dismissWarnings(){ warnings = []; showWarnings(); }

function toggleDebug(){
  const pre = document.getElementById('debug');
  if (pre.style.display === 'none' || pre.style.display === '') {
    pre.style.display = 'block';
    document.getElementById('btnToggleDebug').textContent = 'Hide debug';
  } else {
    pre.style.display = 'none';
    document.getElementById('btnToggleDebug').textContent = 'Show debug';
  }
}

async function init() {
  showMessage('Memulai ambil CSV: ' + PUB_CSV_URL);
  try {
    const csvText = await fetchCsv(PUB_CSV_URL);
    parseCsv(csvText);
    renderPreview();
    buildAndDraw();
    showMessage('Sukses memuat data. Baris: ' + rows.length);
  } catch (err) {
    console.error(err);
    logDebug('ERROR: ' + err.message);
    document.getElementById('chart_div').innerHTML = '<div class="small-muted">Gagal memuat data: ' + err.message + '</div>';
  }
}

async function fetchCsv(url) {
  const r = await fetch(url, {mode:'cors'});
  if (!r.ok) throw new Error('HTTP ' + r.status + ' saat fetch CSV');
  return await r.text();
}

function parseCsv(text) {
  logDebug('Parsing CSV (chars: ' + text.length + ')');

  const rowsRaw = [];
  let cur = '';
  let inQuotes = false;
  for (let i=0;i<text.length;i++) {
    const ch = text[i];
    const next = text[i+1];
    if (ch === '"') {
      if (inQuotes && next === '"') { cur += '"'; i++; continue; }
      inQuotes = !inQuotes;
      continue;
    }
    if (ch === '\n' && !inQuotes) {
      rowsRaw.push(cur.replace(/\r$/,'')); cur = ''; continue;
    }
    cur += ch;
  }
  if (cur !== '') rowsRaw.push(cur);

  const parsed = rowsRaw.map(r => {
    const cells = [];
    let cell = '';
    let q = false;
    for (let i=0;i<r.length;i++){
      const ch = r[i];
      if (ch === '"') { q = !q; continue; }
      if (ch === ',' && !q) { cells.push(cell); cell=''; continue; }
      cell += ch;
    }
    cells.push(cell);
    return cells.map(c => c.trim());
  });

  if (parsed.length === 0) throw new Error('CSV kosong');
  headers = parsed[0].map(h => h || '');
  rows = parsed.slice(1).filter(r => r.some(c => c !== ''));
  logDebug('headers: ' + headers.join(' | '));
  logDebug('rows loaded: ' + rows.length);
}

function renderPreview() {
  const container = document.getElementById('preview_table');
  const sample = rows.slice(0,10);
  let html = '<table class="preview"><thead><tr>';
  for (const h of headers) html += '<th>' + escapeHtml(h) + '</th>';
  html += '</tr></thead><tbody>';
  for (const r of sample) {
    html += '<tr>';
    for (let i=0;i<headers.length;i++) html += '<td>' + escapeHtml(r[i] || '') + '</td>';
    html += '</tr>';
  }
  html += '</tbody></table>';
  container.innerHTML = html;
  // ensure preview wrapper scrolls; table min-width so horizontal scrollbar appears if needed
}

function findHeaderIndex(names) {
  for (const name of names) {
    const idx = headers.findIndex(h => h && h.toLowerCase().includes(name.toLowerCase()));
    if (idx !== -1) return idx;
  }
  return -1;
}

function rowsToGanttData(filteredRows) {
  warnings = [];
  const idIdx = findHeaderIndex(['id','no','ticket']);
  const nameIdx = findHeaderIndex(['task name','task','site_name','site name','ticket','catatan','site','site_name_down','site_name_detect','site_name_down','site_name_detect']);
  const resourceIdx = findHeaderIndex(['tenant','teknisi','resource','owner','nama_tacc','nama','teknisi']);
  const startIdx = findHeaderIndex(['start','created_at','created','tanggal','date','created_at']);
  const endIdx = findHeaderIndex(['end','closed_at','closed','end date','tanggal selesai','closed_at','closed_at']);
  const pctIdx = findHeaderIndex(['%','percent','progress','status progress','status','status progress','status_progress','status_progress']);

  logDebug('mapping idx => id:' + idIdx + ' name:' + nameIdx + ' res:' + resourceIdx + ' start:' + startIdx + ' end:' + endIdx + ' pct:' + pctIdx);

  const data = new google.visualization.DataTable();
  data.addColumn('string','Task ID');
  data.addColumn('string','Task Name');
  data.addColumn('string','Resource');
  data.addColumn('date','Start Date');
  data.addColumn('date','End Date');
  data.addColumn('number','Duration');
  data.addColumn('number','Percent Complete');
  data.addColumn('string','Dependencies');

  for (const r of filteredRows) {
    const id = idIdx>=0 ? r[idIdx] : '';
    const name = nameIdx>=0 ? r[nameIdx] : (r[0] || '');
    const resource = resourceIdx>=0 ? r[resourceIdx] : '';
    const startRaw = startIdx>=0 ? r[startIdx] : '';
    const endRaw = endIdx>=0 ? r[endIdx] : '';
    const pctRaw = pctIdx>=0 ? r[pctIdx] : '';

    const startDateRaw = parseDateFlexible(startRaw);
    const endDateRaw = parseDateFlexible(endRaw);

    let startDate = startDateRaw;
    let endDate = endDateRaw;

    // If both absent -> skip row (can't display)
    if (!startDate && !endDate) {
      warnings.push('Skipping row (no start/end): ' + (id || name).toString().slice(0,40));
      continue;
    }

    // If start present but end missing -> use start + 1 day
    if (startDate && !endDate) {
      endDate = new Date(startDate.getTime() + 24*3600*1000);
      warnings.push('Missing end for task ' + (id || name) + ' â€” using start+1 day');
    }

    // If end present but start missing -> use end - 1 day
    if (!startDate && endDate) {
      startDate = new Date(endDate.getTime() - 24*3600*1000);
      warnings.push('Missing start for task ' + (id || name) + ' â€” using end-1 day');
    }

    // percent parse
    let pct = 0;
    if (pctRaw) {
      const cleaned = pctRaw.toString().replace('%','').trim();
      const n = Number(cleaned);
      if (!isNaN(n)) pct = Math.max(0, Math.min(100, n));
    }

    data.addRow([
      id || name,
      name,
      resource,
      startDate || null,
      endDate || null,
      null,
      pct,
      null
    ]);
  }

  return data;
}

function parseDateFlexible(txt) {
  if (!txt) return null;
  txt = txt.toString().trim();
  // try YYYY-MM-DD
  let m = txt.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
  if (m) return new Date(+m[1], +m[2]-1, +m[3]);
  // try dd/mm/yyyy
  m = txt.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
  if (m) return new Date(+m[3], +m[2]-1, +m[1]);
  // try to extract date-like substring
  m = txt.match(/(\d{4})-(\d{2})-(\d{2})/);
  if (m) return new Date(+m[1], +m[2]-1, +m[3]);
  // fallback: Date parser
  const d = new Date(txt);
  if (!isNaN(d.getTime())) return d;
  return null;
}

function buildAndDraw(filterText='', statusFilter='all') {
  if (!rows || rows.length === 0) {
    document.getElementById('chart_div').innerHTML = '<div class="small-muted">Data kosong</div>';
    return;
  }

  let filtered = rows.slice();

  if (filterText) {
    const ft = filterText.toLowerCase();
    filtered = filtered.filter(r => r.join(' ').toLowerCase().includes(ft));
  }

  if (statusFilter !== 'all') {
    const pctIdx = findHeaderIndex(['%','percent','progress','status']);
    if (pctIdx >= 0) {
      if (statusFilter === 'inprogress') {
        filtered = filtered.filter(r => { const v = Number((r[pctIdx]||'').toString().replace('%',''))||0; return v < 100; });
      } else {
        filtered = filtered.filter(r => { const v = Number((r[pctIdx]||'').toString().replace('%',''))||0; return v === 100; });
      }
    }
  }

  const data = rowsToGanttData(filtered);

  // show warnings (non-block)
  showWarnings();

  const options = {
    height: Math.max(400, data.getNumberOfRows() * 42),
    gantt: {
      trackHeight: 34,
      labelStyle: { fontName: 'Segoe UI', fontSize: 12, color:'#333' },
      percentEnabled: true,
      percentStyle: { fill: '#4caf50' }
    }
  };

  const chart = new google.visualization.Gantt(document.getElementById('chart_div'));
  chart.draw(data, options);

  // Color bars based on percent (DOM hack)
  setTimeout(() => {
    try {
      const svg = document.querySelector('#chart_div svg');
      if (!svg) return;
      const bars = svg.querySelectorAll('rect.google-visualization-gantt-bar, rect[style*="fill"]');
      for (let i=0;i<bars.length;i++) {
        const rect = bars[i];
        const rowPct = data.getNumberOfRows() > i ? data.getValue(i,6) : null;
        if (rowPct === null || rowPct === undefined) continue;
        if (rowPct >= 100) rect.setAttribute('fill', '#4caf50');
        else if (rowPct > 0) rect.setAttribute('fill', '#ffb74d');
        else rect.setAttribute('fill', '#90caf9');
      }
    } catch(e) {
      logDebug('Warning coloring bars: ' + (e && e.message));
    }
  }, 300);
}

function applyFilters() {
  const txt = document.getElementById('searchInput').value || '';
  const status = document.getElementById('statusFilter').value;
  buildAndDraw(txt, status);
}

function escapeHtml(s) {
  return (s || '').toString()
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
