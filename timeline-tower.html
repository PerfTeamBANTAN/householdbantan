<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TimeLine Tower – Gantt Dashboard (Clean)</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Charts -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --muted:#6c757d;
      --accent:#1e90ff;
      --success:#28a745;
      --warning:#ffb74d;
      --info:#90caf9;
      --danger:#e74c3c;
      --radius:12px;
    }

    body{font-family: "Inter", "Segoe UI", Roboto, Arial; background:var(--bg); margin:0; padding:28px;}

    .topbar{
      display:flex;
      gap:16px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
    }
    .brand { display:flex; align-items:center; gap:12px; }
    .brand img { height:36px; }
    .brand h1 { font-size:18px; margin:0; letter-spacing:0.2px; }

    .card-main{
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      box-shadow: 0 8px 24px rgba(22,34,60,0.06);
    }

    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .controls .form-control, .controls .form-select { min-width:210px; }

    /* Warnings area (collapsed by default) */
    .warnings {
      background: linear-gradient(180deg,#fff8e5,#fff6e0);
      border:1px solid #ffe7b5;
      color:#6a4f00;
      padding:12px 14px;
      border-radius:8px;
      margin:12px 0;
      display:none;
      max-height:200px;
      overflow:auto;
      line-height:1.45;
      font-size:14px;
    }
    .warnings small { display:block; color:var(--muted); margin-top:6px }

    /* Chart card */
    #chart_card { margin-top:8px; border-radius:10px; overflow:hidden; }
    #chart_div { width:100%; height:650px; background:#fff; border-radius:8px; padding:12px 18px; box-sizing:border-box; }
    /* Improve Gantt label readability */
    .google-visualization-gantt-label { font-weight:600 !important; font-size:13px !important; fill:#1f2937 !important; }
    .google-visualization-tooltip { font-family: "Inter", Arial; font-size:13px; }

    /* Preview and Debug hidden by default, toggle with button */
    .preview-wrap { display:none; margin-top:12px; border-radius:8px; overflow:auto; border:1px solid #f0f0f0; background:#fafafa; padding:10px; }
    table.preview { width:100%; border-collapse:collapse; font-size:13px; min-width:1200px; }
    table.preview th, table.preview td { border-bottom:1px solid #eee; padding:6px 8px; text-align:left; white-space:nowrap; }
    pre.debug { display:none; background:#0f1724; color:#f8fafc; padding:12px; border-radius:8px; margin-top:12px; max-height:220px; overflow:auto; }

    /* Legend */
    .legend { display:flex; gap:12px; align-items:center; margin-top:8px; }
    .legend .item { display:flex; gap:8px; align-items:center; font-size:13px; color:var(--muted) }
    .legend .swatch { width:14px; height:10px; border-radius:3px; display:inline-block; }

    /* Responsive tweaks */
    @media (max-width:900px){
      #chart_div { height:520px; }
      .controls .form-control, .controls .form-select { min-width:150px; }
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <img src="PERFORMANCE TEAM.png" alt="logo" onerror="this.style.display='none'">
      <div>
        <h1>PERFORMANCE BAN-TAN — TimeLine Tower</h1>
        <small style="color:var(--muted)">Dashboard Tracking Order (Gantt)</small>
      </div>
    </div>

    <div class="controls">
      <input id="searchInput" class="form-control" type="text" placeholder="Cari: Ticket, Site, Teknisi..." aria-label="search">
      <select id="statusFilter" class="form-select" aria-label="status">
        <option value="all">Semua status</option>
        <option value="inprogress">&lt;100% (In Progress)</option>
        <option value="completed">100% (Completed)</option>
      </select>
      <button id="btnSearch" class="btn btn-primary">Terapkan</button>
      <button id="btnToggleWarnings" class="btn btn-outline-secondary">Show Warnings</button>
      <button id="btnTogglePreview" class="btn btn-outline-secondary">Preview</button>
      <button id="btnToggleDebug" class="btn btn-outline-secondary">Debug</button>
    </div>
  </div>

  <div class="card-main">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <div class="legend">
          <div class="item"><span class="swatch" style="background:var(--success)"></span> Completed (100%)</div>
          <div class="item"><span class="swatch" style="background:var(--warning)"></span> In progress (&lt;100%)</div>
          <div class="item"><span class="swatch" style="background:var(--info)"></span> No % shown</div>
        </div>
        <small class="d-block mt-2" style="color:var(--muted)">Sumber: Google Sheet (CSV publik)</small>
      </div>

      <div style="text-align:right">
        <small class="text-muted">Last update: <span id="lastUpdate">–</span></small>
      </div>
    </div>

    <!-- collapsible warnings -->
    <div id="warnings" class="warnings" role="status" aria-live="polite"></div>

    <!-- chart -->
    <div id="chart_card">
      <div id="chart_div">Memuat Gantt chart…</div>
    </div>

    <!-- preview & debug -->
    <div id="preview_wrap" class="preview-wrap mt-3"></div>
    <pre id="debug" class="debug"></pre>
  </div>

<script>
/* Improved, styled Gantt dashboard using CSV source */
const PUB_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcHZK2xNVK-lRfq_MnNF7MK_4x1iUQJL4ECSf7bBL51Yf7yHdbmGgv5RwtD0RZC6NULyTW7h3-E3o1/pub?gid=1842046587&single=true&output=csv';
const DEBUG_MODE = false;

let headers = [], rows = [], warnings = [];
let lastCsvText = '';

google.charts.load('current', {'packages':['gantt']});
google.charts.setOnLoadCallback(init);

document.getElementById('btnSearch').addEventListener('click', applyFilters);
document.getElementById('btnToggleWarnings').addEventListener('click', toggleWarnings);
document.getElementById('btnTogglePreview').addEventListener('click', togglePreview);
document.getElementById('btnToggleDebug').addEventListener('click', toggleDebug);

function byId(id){ return document.getElementById(id); }
function logDebug(txt){ if (!DEBUG_MODE) return; byId('debug').textContent += txt + '\n'; console.info(txt); }
function showWarnings(){ const el = byId('warnings'); if (!warnings.length){ el.style.display='none'; el.innerHTML=''; return;} el.style.display='block'; el.innerHTML = warnings.map(w => `<div>• ${escapeHtml(w)}</div>`).join('') + '<small style="display:block;margin-top:8px;color:var(--muted)">Klik "Show Warnings" untuk sembunyikan.</small>'; }

async function init(){
  byId('lastUpdate').textContent = new Date().toLocaleString();
  try{
    const csv = await fetchCsv(PUB_CSV_URL);
    lastCsvText = csv;
    parseCsv(csv);
    renderPreview();
    drawCurrent();
  } catch(err){
    byId('chart_div').innerHTML = `<div style="padding:18px;color:#b00020">Gagal load data: ${escapeHtml(err.message)}</div>`;
  }
}

async function fetchCsv(url){
  const r = await fetch(url, {mode:'cors'});
  if (!r.ok) throw new Error('HTTP ' + r.status);
  return await r.text();
}

// ---------- REPLACE EXISTING parseCsv WITH THIS ONE ----------
function parseCsv(text) {
  logDebug('Parsing CSV (chars: ' + text.length + ')');

  // 1) Basic RFC4180-ish parser: produce array of rows (strings joined)
  const rowsRaw = [];
  let cur = '';
  let inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i+1];
    if (ch === '"') {
      if (inQuotes && next === '"') { cur += '"'; i++; continue; } // escaped quote
      inQuotes = !inQuotes;
      continue;
    }
    if (ch === '\n' && !inQuotes) {
      rowsRaw.push(cur.replace(/\r$/,'')); cur = ''; continue;
    }
    cur += ch;
  }
  if (cur !== '') rowsRaw.push(cur);

  // 2) Split each logical row by commas, handling quoted fields (again)
  const parsed = rowsRaw.map(r => {
    const cells = [];
    let cell = '';
    let q = false;
    for (let i = 0; i < r.length; i++) {
      const ch = r[i];
      if (ch === '"' ) { q = !q; continue; }
      if (ch === ',' && !q) { cells.push(cell); cell = ''; continue; }
      cell += ch;
    }
    cells.push(cell);
    return cells.map(c => c.trim());
  });

  if (parsed.length === 0) throw new Error('CSV kosong');

  // 3) Find the mode (most common) column count among all parsed rows
  const colCountFreq = {};
  parsed.forEach(r => {
    const n = r.length;
    colCountFreq[n] = (colCountFreq[n] || 0) + 1;
  });
  let modeCols = null;
  let maxFreq = 0;
  for (const k in colCountFreq) {
    if (colCountFreq[k] > maxFreq) { maxFreq = colCountFreq[k]; modeCols = Number(k); }
  }
  logDebug('Detected mode column count = ' + modeCols);

  // 4) If the first row length !== modeCols, find the first row that matches modeCols and use it as header.
  let headerRowIndex = 0;
  if (parsed[0].length !== modeCols) {
    const foundIdx = parsed.findIndex((r, idx) => r.length === modeCols);
    if (foundIdx !== -1) {
      headerRowIndex = foundIdx;
      logDebug('First row columns ('+parsed[0].length+') != modeCols. Using row ' + foundIdx + ' as header.');
    } else {
      // fallback: if no row matches mode, still use first row but we'll try to normalize sizes later
      headerRowIndex = 0;
      logDebug('No row matched modeCols; using first row as header (fallback).');
    }
  } else {
    headerRowIndex = 0;
  }

  // 5) Assign headers and data rows
  headers = parsed[headerRowIndex].map(h => h || '');

  // data rows are rows after headerRowIndex
  rows = parsed.slice(headerRowIndex + 1).filter(r => r.some(cell => cell !== ''));

  // 6) If some data rows have different column counts, pad or trim them to modeCols to keep alignment
  rows = rows.map(r => {
    if (r.length < modeCols) {
      // pad with empty strings
      return r.concat(Array(modeCols - r.length).fill(''));
    } else if (r.length > modeCols) {
      // trim extra columns (if they exist at the end)
      return r.slice(0, modeCols);
    }
    return r;
  });

  // 7) If header length doesn't equal modeCols, adjust header similarly (pad/trim)
  if (headers.length < modeCols) headers = headers.concat(Array(modeCols - headers.length).fill(''));
  else if (headers.length > modeCols) headers = headers.slice(0, modeCols);

  logDebug('Final header count = ' + headers.length + ' | rows loaded = ' + rows.length);
  logDebug('headers: ' + headers.join(' | '));
  logDebug('first row sample: ' + JSON.stringify(rows.slice(0,4)));
}

function renderPreview(){
  const container = byId('preview_wrap');
  // build table HTML but keep hidden by default (toggle visible)
  let html = '<table class="preview"><thead><tr>';
  for (const h of headers) html += `<th>${escapeHtml(h)}</th>`;
  html += '</tr></thead><tbody>';
  for (let i=0;i<Math.min(10, rows.length); i++){
    const r = rows[i];
    html += '<tr>';
    for (let j=0;j<headers.length;j++) html += `<td>${escapeHtml(r[j]||'')}</td>`;
    html += '</tr>';
  }
  html += '</tbody></table>';
  container.innerHTML = html;
}

/* Identify columns by keywords; tolerant mapping */
function findHeaderIndex(names){
  for (const n of names){
    const idx = headers.findIndex(h => h && h.toLowerCase().includes(n.toLowerCase()));
    if (idx !== -1) return idx;
  }
  return -1;
}

/* Build DataTable for google gantt; fallback dates handled:
   - if only end present -> start = end -1d
   - if only start present -> end = start +1d
*/
function rowsToGanttData(filteredRows){
  warnings = [];
  const idIdx = findHeaderIndex(['id','no','ticket']);
  const nameIdx = findHeaderIndex(['site_name','site','site_name_down','site_name_detect','site name','ticket','catatan','nama']);
  const resourceIdx = findHeaderIndex(['tenant','teknisi','nama','nama_tacc','owner']);
  const startIdx = findHeaderIndex(['created_at','created','start','tanggal','date']);
  const endIdx = findHeaderIndex(['closed_at','closed','end','finish','tanggal selesai']);
  const pctIdx = findHeaderIndex(['status progress','status','progress','%','percent']);

  logDebug(`map idx id:${idIdx} name:${nameIdx} res:${resourceIdx} start:${startIdx} end:${endIdx} pct:${pctIdx}`);

  const data = new google.visualization.DataTable();
  data.addColumn('string','Task ID');
  data.addColumn('string','Task Name');
  data.addColumn('string','Resource');
  data.addColumn('date','Start Date');
  data.addColumn('date','End Date');
  data.addColumn('number','Duration');
  data.addColumn('number','Percent Complete');
  data.addColumn('string','Dependencies');

  for (const r of filteredRows){
    const id = idIdx>=0 ? r[idIdx] : '';
    const name = nameIdx>=0 ? r[nameIdx] : (r[1]||r[0]||'');
    const resource = resourceIdx>=0 ? r[resourceIdx] : '';
    const startRaw = startIdx>=0 ? r[startIdx] : '';
    const endRaw = endIdx>=0 ? r[endIdx] : '';
    const pctRaw = pctIdx>=0 ? r[pctIdx] : '';

    let start = parseDateFlexible(startRaw);
    let end = parseDateFlexible(endRaw);

    if (!start && !end){
      warnings.push(`Skipping row (no date): ${id || truncate(name,50)}`);
      continue;
    }
    if (start && !end){ end = new Date(start.getTime() + 24*3600*1000); /* +1 day */ warnings.push(`Missing end for ${id||name} — using start+1d`); }
    if (!start && end){ start = new Date(end.getTime() - 24*3600*1000); warnings.push(`Missing start for ${id||name} — using end-1d`); }

    let pct = 0;
    if (pctRaw){
      const cleaned = pctRaw.toString().replace('%','').trim();
      const n = Number(cleaned);
      if (!isNaN(n)) pct = Math.max(0, Math.min(100, n));
    }

    data.addRow([ id || name, name, resource, start, end, null, pct, null ]);
  }

  return {data,meta:{idIdx,nameIdx,resourceIdx,startIdx,endIdx,pctIdx}};
}

function drawCurrent(filterText='', statusFilter='all'){
  if (!rows || !rows.length){ byId('chart_div').innerHTML = '<div style="padding:18px;color:var(--muted)">Data kosong</div>'; return; }

  let filtered = rows.slice();
  if (filterText){
    const ft = filterText.toLowerCase();
    filtered = filtered.filter(r => r.join(' ').toLowerCase().includes(ft));
  }

  if (statusFilter !== 'all'){
    const pctIdx = findHeaderIndex(['status progress','status','progress','%','percent']);
    if (pctIdx >= 0){
      if (statusFilter === 'inprogress') filtered = filtered.filter(r => (Number((r[pctIdx]||'').toString().replace('%',''))||0) < 100);
      else filtered = filtered.filter(r => (Number((r[pctIdx]||'').toString().replace('%',''))||0) === 100);
    }
  }

  const {data, meta} = rowsToGanttData(filtered);
  showWarnings();

  const options = {
    height: Math.max(420, data.getNumberOfRows() * 46),
    gantt: {
      trackHeight: 36,
      labelStyle: { fontName:'Inter,Segoe UI', fontSize:13, color:'#1f2937' },
      percentEnabled: true,
      arrow: { angle: 45, width: 2, color: '#6c757d', radius: 0 }
    }
  };

  const chartDiv = byId('chart_div');
  const chart = new google.visualization.Gantt(chartDiv);
  chart.draw(data, options);

  // color bars by percent (DOM tweak)
  setTimeout(() => {
    try {
      const svg = chartDiv.querySelector('svg');
      if (!svg) return;
      // bars usually have class google-visualization-gantt-bar (but may vary)
      const bars = svg.querySelectorAll('rect.google-visualization-gantt-bar, rect[role="presentation"]');
      for (let i=0;i<bars.length;i++){
        const rect = bars[i];
        const rowPct = data.getNumberOfRows() > i ? data.getValue(i,6) : null;
        if (rowPct === null || rowPct === undefined) continue;
        if (rowPct >= 100) rect.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue('--success') || '#28a745');
        else if (rowPct > 0) rect.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue('--warning') || '#ffb74d');
        else rect.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue('--info') || '#90caf9');
        rect.setAttribute('rx','3'); rect.setAttribute('ry','3');
      }
      // make labels nicer: add tooltip title attribute to labels (if present)
      const labels = svg.querySelectorAll('text');
      for (const lab of labels){
        const txt = lab.textContent || '';
        if (txt) lab.setAttribute('title', txt.trim());
      }
    } catch(e){ logDebug('Coloring bars error: ' + e.message); }
  }, 220);
}

/* Helpers */
function parseDateFlexible(txt){
  if (!txt) return null;
  txt = txt.toString().trim();
  let m = txt.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
  if (m) return new Date(+m[1], +m[2]-1, +m[3]);
  m = txt.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
  if (m) return new Date(+m[3], +m[2]-1, +m[1]);
  m = txt.match(/(\d{4})-(\d{2})-(\d{2})/);
  if (m) return new Date(+m[1], +m[2]-1, +m[3]);
  const d = new Date(txt);
  if (!isNaN(d.getTime())) return d;
  return null;
}
function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function truncate(s,n){ if(!s) return ''; s = s.toString(); return s.length > n ? s.slice(0,n-1) + '…' : s; }

/* UI toggles */
function toggleWarnings(){
  const el = byId('warnings');
  if (el.style.display === 'none' || el.style.display === ''){ el.style.display='block'; byId('btnToggleWarnings').textContent='Hide Warnings'; }
  else { el.style.display='none'; byId('btnToggleWarnings').textContent='Show Warnings'; }
}
function togglePreview(){
  const el = byId('preview_wrap');
  if (el.style.display === 'none' || el.style.display === ''){ el.style.display='block'; byId('btnTogglePreview').textContent='Hide Preview'; }
  else { el.style.display='none'; byId('btnTogglePreview').textContent='Preview'; }
}
function toggleDebug(){
  const el = byId('debug');
  if (el.style.display === 'none' || el.style.display === ''){ el.style.display='block'; byId('btnToggleDebug').textContent='Hide Debug'; }
  else { el.style.display='none'; byId('btnToggleDebug').textContent='Debug'; }
}

/* Apply filters from UI */
function applyFilters(){
  const q = byId('searchInput').value || '';
  const status = byId('statusFilter').value || 'all';
  drawCurrent(q, status);
  // update warnings content and notify
  byId('lastUpdate').textContent = new Date().toLocaleString();
}

/* INITIAL draw helper to call drawCurrent and populate warnings */
function drawCurrent(){
  drawCurrent = function(){ /* placeholder to be replaced below */ }; // prevent hoisting confusion
  // initial call below after define drawCurrent correctly (workaround)
}
/* Reassign drawCurrent properly and call it */
drawCurrent = function(q='', status='all'){
  // if rows not loaded, do nothing
  if (!rows || rows.length === 0){ byId('chart_div').innerHTML = '<div style="padding:18px;color:var(--muted)">Data kosong</div>'; return; }
  // filter logic re-used from earlier
  let filtered = rows.slice();
  if (q){
    const ft = q.toLowerCase();
    filtered = filtered.filter(r => r.join(' ').toLowerCase().includes(ft));
  }
  if (status !== 'all'){
    const pctIdx = findHeaderIndex(['status progress','status','progress','%','percent']);
    if (pctIdx >= 0){
      if (status === 'inprogress') filtered = filtered.filter(r => (Number((r[pctIdx]||'').toString().replace('%',''))||0) < 100);
      else filtered = filtered.filter(r => (Number((r[pctIdx]||'').toString().replace('%',''))||0) === 100);
    }
  }
  const {data} = rowsToGanttData(filtered);
  byId('warnings').style.display = warnings.length ? 'none' : 'none'; // default hidden; user can open
  showWarnings();
  const options = {
    height: Math.max(420, data.getNumberOfRows() * 46),
    gantt: {
      trackHeight: 36,
      labelStyle: { fontName:'Inter,Segoe UI', fontSize:13, color:'#1f2937' },
      percentEnabled: true
    }
  };
  const chart = new google.visualization.Gantt(byId('chart_div'));
  chart.draw(data, options);
  // color bars
  setTimeout(() => {
    try {
      const svg = byId('chart_div').querySelector('svg');
      if (!svg) return;
      const bars = svg.querySelectorAll('rect.google-visualization-gantt-bar, rect[role="presentation"]');
      for (let i=0;i<bars.length;i++){
        const rect = bars[i];
        const rowPct = data.getNumberOfRows() > i ? data.getValue(i,6) : null;
        if (rowPct === null || rowPct === undefined) continue;
        if (rowPct >= 100) rect.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue('--success') || '#28a745');
        else if (rowPct > 0) rect.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue('--warning') || '#ffb74d');
        else rect.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue('--info') || '#90caf9');
        rect.setAttribute('rx','4'); rect.setAttribute('ry','4');
      }
    } catch(e){ logDebug('Color error:' + e.message); }
  }, 240);
};

/* Kick initial UI state */
byId('warnings').style.display='none';
byId('preview_wrap').style.display='none';
byId('debug').style.display='none';
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

