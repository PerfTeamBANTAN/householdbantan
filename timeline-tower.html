<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TimeLine Tower - Dashboard (Gantt dari published sheet)</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Charts (Gantt) -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    body { font-family: "Segoe UI", Roboto, Arial; background:#f7f7f8; padding-top:72px; }
    .chart-card { max-width:1200px; margin:20px auto; padding:20px; background:#fff; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.05); }
    #chart_div { height:700px; width:100%; }
    .small-muted { color:#6c757d; font-size:0.9rem; }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">PERFORMANCE BAN-TAN</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="#">Home</a></li>
          <li class="nav-item"><a class="nav-link active" href="#">KPI 12 PI Laten</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="chart-card">
    <div class="d-flex align-items-start justify-content-between mb-3">
      <div>
        <h4 class="mb-0">ðŸ“Š Dashboard Tracking Order â€“ TimeLine Tower</h4>
        <div class="small-muted">Sumber: Google Sheet (published)</div>
      </div>

      <div class="d-flex gap-2">
        <input id="searchInput" class="form-control" type="text" placeholder="Cari Task atau Nama Tower...">
        <select id="statusFilter" class="form-select">
          <option value="all">Semua status</option>
          <option value="inprogress">&lt;100% (In progress)</option>
          <option value="completed">100% (Completed)</option>
        </select>
        <button id="btnSearch" class="btn btn-primary">Cari</button>
      </div>
    </div>

    <div id="chart_div">Loading chartâ€¦</div>
    <div id="message" class="mt-3 small-muted"></div>
  </div>

<script>
  // ==========================
  // CONFIG: ganti URL pubhtml jika perlu
  // ==========================
  const PUBHTML_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcHZK2xNVK-lRfq_MnNF7MK_4x1iUQJL4ECSf7bBL51Yf7yHdbmGgv5RwtD0RZC6NULyTW7h3-E3o1/pubhtml?gid=1842046587&single=true';
  // ==========================

  google.charts.load('current', {'packages':['gantt']});
  google.charts.setOnLoadCallback(init);

  let rawRows = []; // parsed rows
  let headers = [];

  document.getElementById('btnSearch').addEventListener('click', applyFilters);

  function showMessage(text, isError = false) {
    const el = document.getElementById('message');
    el.textContent = text || '';
    el.style.color = isError ? '#b00020' : '#6c757d';
  }

  async function init() {
    showMessage('Mengambil data dari Google Sheets...');

    try {
      const html = await fetchPubHtml(PUBHTML_URL);
      parsePubHtmlTable(html);
      buildAndDraw(); // initial draw
      showMessage('');
    } catch (err) {
      console.error('INIT ERROR:', err);
      showMessage('Gagal mengambil atau mem-parse data: ' + err.message, true);
      document.getElementById('chart_div').innerHTML = '<div class="small-muted">Tidak dapat memuat data. Pastikan sheet sudah di-Publish to web dan URL pubhtml benar serta publik.</div>';
    }
  }

  // Fetch the pubhtml page as text
  async function fetchPubHtml(url) {
    // Pastikan dijalankan via http/https (bukan file://) agar fetch dapat dilakukan
    const res = await fetch(url, {mode: 'cors'});
    if (!res.ok) throw new Error('HTTP ' + res.status + ' fetching pubhtml');
    return await res.text();
  }

  // Robust parser: try table.waffle -> any table -> regex find table -> parse it
  function parsePubHtmlTable(htmlText) {
    console.info('parsePubHtmlTable: mem-parsing pubhtml, panjang html:', htmlText.length);

    const doc = new DOMParser().parseFromString(htmlText, 'text/html');

    // 1) coba cari table.waffle
    let table = doc.querySelector('table.waffle') || doc.querySelector('table');

    // 2) Kalau belum ketemu, coba cari string "<table" via regex dan parse potongan pertama yang ditemukan
    if (!table) {
      console.warn('Tidak menemukan <table> langsung â€” mencoba regex untuk ambil potongan <table>...</table>');
      const regex = /<table[\s\S]*?<\/table>/i;
      const m = htmlText.match(regex);
      if (m && m[0]) {
        const snippet = m[0];
        const doc2 = new DOMParser().parseFromString(snippet, 'text/html');
        table = doc2.querySelector('table');
        if (table) console.info('Berhasil parse table via regex snippet.');
      } else {
        console.warn('Regex tidak menemukan tag <table> dalam pubhtml.');
      }
    }

    if (!table) {
      // Tambah pemeriksaan lebih spesifik: Google sometimes embeds table inside iframe srcdoc etc.
      // Cek adanya iframe yang mengandung /pub? atau /htmlembed
      const iframe = doc.querySelector('iframe');
      if (iframe && iframe.src) {
        console.info('Menemukan <iframe>, src=', iframe.src);
        throw new Error('Ditemukan iframe pada pubhtml. Coba buka iframe src secara langsung di tab baru dan pastikan itu menampilkan tabel (kemungkinan struktur berbeda).');
      }
      throw new Error('Tidak menemukan tabel pada pubhtml. Pastikan kamu memilih sheet yang benar saat Publish (File â†’ Publish to web â†’ Pilih sheet), dan buka link pubhtml untuk memverifikasi tabel terlihat.');
    }

    const trs = Array.from(table.querySelectorAll('tr'));
    if (trs.length < 1) throw new Error('Tabel ditemukan tetapi kosong.');

    headers = Array.from(trs[0].querySelectorAll('td,th')).map(h => h.textContent.trim());
    rawRows = trs.slice(1).map(tr => {
      const tds = Array.from(tr.querySelectorAll('td'));
      return tds.map(td => td.textContent.trim());
    }).filter(r => r.some(cell => cell !== ''));

    console.info('parsePubHtmlTable -> headers:', headers);
    console.info('parsePubHtmlTable -> sample rows:', rawRows.slice(0,5));
  }

  // Convert rawRows + headers to DataTable format expected by Google Gantt
  function rowsToGanttData(rows) {
    function findHeaderIndex(names) {
      for (const name of names) {
        const idx = headers.findIndex(h => h.toLowerCase().includes(name.toLowerCase()));
        if (idx !== -1) return idx;
      }
      return -1;
    }

    const idxId = findHeaderIndex(['id','no','task id','taskid']);
    const idxName = findHeaderIndex(['task name','task','site_name','site_name_down','nama','ticket','ticket']);
    const idxResource = findHeaderIndex(['resource','tenant','teknisi','owner','pemilik','site_det']);
    const idxStart = findHeaderIndex(['start','created_at','tanggal','start date','start_date','created']);
    const idxEnd = findHeaderIndex(['end','closed_at','closed','end date','end_date','closed_at']);
    const idxDuration = findHeaderIndex(['duration','durasi']);
    const idxPct = findHeaderIndex(['%','percent','progress','status progress','progress%','status']);
    const idxDep = findHeaderIndex(['dep','dependency','dependencies']);

    const data = new google.visualization.DataTable();
    data.addColumn('string', 'Task ID');
    data.addColumn('string', 'Task Name');
    data.addColumn('string', 'Resource');
    data.addColumn('date', 'Start Date');
    data.addColumn('date', 'End Date');
    data.addColumn('number', 'Duration'); // milliseconds (optional, set null)
    data.addColumn('number', 'Percent Complete');
    data.addColumn('string', 'Dependencies');

    for (const r of rows) {
      const id = idxId >=0 ? r[idxId] || '' : '';
      const name = idxName >=0 ? r[idxName] || '' : (r[1] || '');
      const resource = idxResource >=0 ? r[idxResource] || '' : '';
      const startRaw = idxStart>=0 ? r[idxStart] : '';
      const endRaw = idxEnd>=0 ? r[idxEnd] : '';
      const durRaw = idxDuration>=0 ? r[idxDuration] : '';
      const pctRaw = idxPct>=0 ? r[idxPct] : '';
      const dep = idxDep>=0 ? r[idxDep] || null : null;

      const startDate = parseDateFlexible(startRaw);
      const endDate = parseDateFlexible(endRaw);

      let pct = null;
      if (pctRaw) {
        const cleaned = pctRaw.toString().replace('%','').trim();
        const n = Number(cleaned);
        if (!Number.isNaN(n)) pct = Math.max(0, Math.min(100, n));
      }

      let durationMs = null;
      if (!endDate && durRaw) {
        const d = Number(durRaw);
        if (!Number.isNaN(d)) durationMs = d * 24 * 3600 * 1000;
      }

      if (!startDate && !endDate && durationMs === null) {
        // If no dates and no duration, skip
        continue;
      }

      data.addRow([
        id || name,
        name,
        resource,
        startDate || null,
        endDate || null,
        durationMs,
        pct !== null ? pct : 0,
        dep || null
      ]);
    }

    return data;
  }

  function parseDateFlexible(txt) {
    if (!txt) return null;
    txt = txt.trim();
    // Try ISO YYYY-MM-DD or YYYY/MM/DD
    const isoMatch = txt.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
    if (isoMatch) {
      const y = +isoMatch[1], m = +isoMatch[2]-1, d = +isoMatch[3];
      return new Date(y,m,d);
    }
    // dd/mm/yyyy
    const dmy = txt.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if (dmy) {
      const d = +dmy[1], m = +dmy[2]-1, y = +dmy[3];
      return new Date(y,m,d);
    }
    // Some pubhtml shows "2025-10-27 10:1 - " or similar; try extract date-like part
    const dtExtract = txt.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
    if (dtExtract) {
      const y = +dtExtract[1], m = +dtExtract[2]-1, d = +dtExtract[3];
      return new Date(y,m,d);
    }
    // fallback Date()
    const dt = new Date(txt);
    if (!isNaN(dt.getTime())) return dt;
    return null;
  }

  function buildAndDraw(filterText = '', statusFilter = 'all') {
    if (!rawRows || rawRows.length === 0) {
      showMessage('Tidak ada data untuk ditampilkan.', true);
      return;
    }

    let filtered = rawRows.slice();

    if (filterText) {
      const ft = filterText.toLowerCase();
      filtered = filtered.filter(row => row.join(' ').toLowerCase().includes(ft));
    }

    if (statusFilter !== 'all') {
      const pctIdx = headers.findIndex(h => /%|percent|progress|complete|status progress/i.test(h));
      if (pctIdx >= 0) {
        if (statusFilter === 'inprogress') {
          filtered = filtered.filter(r => {
            const v = r[pctIdx] ? Number(r[pctIdx].toString().replace('%','')) : 0;
            return v < 100;
          });
        } else if (statusFilter === 'completed') {
          filtered = filtered.filter(r => {
            const v = r[pctIdx] ? Number(r[pctIdx].toString().replace('%','')) : 0;
            return v === 100;
          });
        }
      }
    }

    const data = rowsToGanttData(filtered);

    const options = {
      height: Math.max(400, data.getNumberOfRows() * 40),
      gantt: {
        trackHeight: 32,
        labelStyle: { fontName: 'Segoe UI', fontSize: 12, color:'#333' },
        percentEnabled: true,
        percentStyle: { fill: '#4caf50' },
      }
    };

    const chart = new google.visualization.Gantt(document.getElementById('chart_div'));
    chart.draw(data, options);
  }

  function applyFilters() {
    const txt = document.getElementById('searchInput').value || '';
    const status = document.getElementById('statusFilter').value;
    buildAndDraw(txt, status);
  }

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
