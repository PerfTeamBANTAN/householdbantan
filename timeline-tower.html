<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TimeLine Tower - CSV -> Gantt</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    body { font-family: "Segoe UI", Arial; background:#f7f7f8; padding-top:72px; }
    .chart-card { max-width:1200px; margin:20px auto; padding:20px; background:#fff; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.05); }
    #chart_div { height:700px; width:100%; }
    .small-muted { color:#6c757d; font-size:0.9rem; }
    pre.debug { max-height:140px; overflow:auto; background:#f1f1f1; padding:10px; border-radius:6px; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">PERFORMANCE BAN-TAN</a>
  </div>
</nav>

<div class="chart-card">
  <div class="d-flex align-items-start justify-content-between mb-3">
    <div>
      <h4 class="mb-0">ðŸ“Š Dashboard Tracking Order â€“ TimeLine Tower (CSV)</h4>
      <div class="small-muted">Sumber: Google Sheet (published â†’ CSV)</div>
    </div>

    <div class="d-flex gap-2">
      <input id="searchInput" class="form-control" type="text" placeholder="Cari Task atau Nama Tower...">
      <select id="statusFilter" class="form-select">
        <option value="all">Semua status</option>
        <option value="inprogress">&lt;100% (In progress)</option>
        <option value="completed">100% (Completed)</option>
      </select>
      <button id="btnSearch" class="btn btn-primary">Cari</button>
    </div>
  </div>

  <div id="chart_div">Loading chartâ€¦</div>
  <div id="message" class="mt-3 small-muted"></div>

  <hr />
  <div>
    <strong>Debug:</strong>
    <pre id="debug" class="debug"></pre>
  </div>
</div>

<script>
/*
  Cara kerja:
  - Ambil CSV publik dari Google Sheets (PUB_CSV_URL)
  - Parse CSV ke array rows
  - Temukan index kolom secara toleran
  - Convert -> google.visualization.DataTable dan draw gantt
*/

// === CONFIG ===
// Gunakan URL CSV publik (format: /pub?gid=...&single=true&output=csv)
const PUB_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcHZK2xNVK-lRfq_MnNF7MK_4x1iUQJL4ECSf7bBL51Yf7yHdbmGgv5RwtD0RZC6NULyTW7h3-E3o1/pub?gid=1842046587&single=true&output=csv';
// Jika link tidak bekerja, buka halaman Publish to web lalu dapatkan link CSV (pub?output=csv)
const DEBUG = true;
// ==============

google.charts.load('current', {'packages':['gantt']});
google.charts.setOnLoadCallback(init);

document.getElementById('btnSearch').addEventListener('click', applyFilters);

function showMessage(text, isError=false) {
  const el = document.getElementById('message');
  el.textContent = text || '';
  el.style.color = isError ? '#b00020' : '#6c757d';
  if (DEBUG) logDebug('MSG: ' + text);
}

function logDebug(txt) {
  if (!DEBUG) return;
  const d = document.getElementById('debug');
  d.textContent += txt + "\n";
}

let headers = [];
let rows = []; // array of arrays

async function init() {
  showMessage('Mengambil CSV dari Google Sheets...');
  logDebug('CSV URL: ' + PUB_CSV_URL);
  try {
    const csvText = await fetchCsv(PUB_CSV_URL);
    parseCsv(csvText);
    showMessage('Data berhasil diambil. Baris: ' + rows.length);
    buildAndDraw();
  } catch (err) {
    console.error(err);
    showMessage('Gagal mengambil data: ' + err.message, true);
  }
}

async function fetchCsv(url) {
  // CORS: pub CSV seharusnya bisa di-fetch dari browser
  const res = await fetch(url, {mode: 'cors'});
  if (!res.ok) throw new Error('HTTP ' + res.status + ' saat fetch CSV');
  return await res.text();
}

// CSV parser sederhana namun robust terhadap kutipan
function parseCsv(text) {
  logDebug('Parsing CSV, panjang: ' + text.length);
  // Split into rows but handle quoted newlines
  const rowsRaw = [];
  let cur = '';
  let inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i+1];
    if (ch === '"') {
      if (inQuotes && next === '"') { // escaped quote
        cur += '"';
        i++;
        continue;
      }
      inQuotes = !inQuotes;
      continue;
    }
    if (ch === '\n' && !inQuotes) {
      rowsRaw.push(cur.replace(/\r$/,'')); // remove trailing \r
      cur = '';
      continue;
    }
    cur += ch;
  }
  if (cur.length) rowsRaw.push(cur);

  // split each row by commas (handling quoted fields already removed)
  const parsed = rowsRaw.map(r => {
    const cells = [];
    let cell = '';
    let q = false;
    for (let i = 0; i < r.length; i++) {
      const ch = r[i];
      if (ch === '"' ) {
        q = !q; // toggle â€” ideally quotes removed earlier, but keep tolerance
        continue;
      }
      if (ch === ',' && !q) {
        cells.push(cell);
        cell = '';
        continue;
      }
      cell += ch;
    }
    cells.push(cell);
    return cells.map(c => c.trim());
  });

  if (parsed.length === 0) throw new Error('CSV kosong');
  headers = parsed[0];
  rows = parsed.slice(1).filter(r => r.some(cell=>cell !== ''));
  logDebug('headers: ' + headers.join(' | '));
  logDebug('first rows sample: ' + JSON.stringify(rows.slice(0,5)));
}

// Map columns tolerant
function findHeaderIndex(names) {
  for (const n of names) {
    const idx = headers.findIndex(h => h && h.toLowerCase().includes(n.toLowerCase()));
    if (idx !== -1) return idx;
  }
  return -1;
}

function rowsToGanttData(filteredRows) {
  const idIdx = findHeaderIndex(['id','no','ticket']);
  const nameIdx = findHeaderIndex(['task name','task','site_name','site name','ticket','catatan','site']);
  const resourceIdx = findHeaderIndex(['tenant','teknisi','resource','owner','nama_tacc','nama']);
  const startIdx = findHeaderIndex(['start','created_at','created','tanggal','date']);
  const endIdx = findHeaderIndex(['end','closed_at','closed','end date','tanggal selesai','closed_at']);
  const pctIdx = findHeaderIndex(['%','percent','progress','status progress','status']);

  logDebug('idx mapping: id='+idIdx+', name='+nameIdx+', res='+resourceIdx+', start='+startIdx+', end='+endIdx+', pct='+pctIdx);

  const data = new google.visualization.DataTable();
  data.addColumn('string','Task ID');
  data.addColumn('string','Task Name');
  data.addColumn('string','Resource');
  data.addColumn('date','Start Date');
  data.addColumn('date','End Date');
  data.addColumn('number','Duration');
  data.addColumn('number','Percent Complete');
  data.addColumn('string','Dependencies');

  for (const r of filteredRows) {
    const id = idIdx>=0 ? r[idIdx] : '';
    const name = nameIdx>=0 ? r[nameIdx] : (r[0]||'');
    const resource = resourceIdx>=0 ? r[resourceIdx] : '';
    const startRaw = startIdx>=0 ? r[startIdx] : '';
    const endRaw = endIdx>=0 ? r[endIdx] : '';
    const pctRaw = pctIdx>=0 ? r[pctIdx] : '';

    const startDate = parseDateFlexible(startRaw);
    const endDate = parseDateFlexible(endRaw);

    let pct = 0;
    if (pctRaw) {
      const cleaned = pctRaw.toString().replace('%','').trim();
      const n = Number(cleaned);
      if (!isNaN(n)) pct = Math.max(0, Math.min(100, n));
    }

    // If start & end both missing, skip row
    if (!startDate && !endDate) continue;

    data.addRow([
      id || name,
      name,
      resource,
      startDate || null,
      endDate || null,
      null,
      pct,
      null
    ]);
  }
  return data;
}

// flexible date parse
function parseDateFlexible(txt) {
  if (!txt) return null;
  txt = txt.toString().trim();
  // try YYYY-MM-DD
  let m = txt.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
  if (m) return new Date(+m[1], +m[2]-1, +m[3]);
  // try dd/mm/yyyy
  m = txt.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
  if (m) return new Date(+m[3], +m[2]-1, +m[1]);
  // try extract first YYYY-MM-DD in string
  m = txt.match(/(\d{4})-(\d{2})-(\d{2})/);
  if (m) return new Date(+m[1], +m[2]-1, +m[3]);
  // fallback Date parse
  const d = new Date(txt);
  if (!isNaN(d.getTime())) return d;
  return null;
}

function buildAndDraw(filterText = '', statusFilter = 'all') {
  if (!rows || rows.length === 0) {
    showMessage('Tidak ada data untuk ditampilkan', true);
    return;
  }
  let filtered = rows.slice();

  if (filterText) {
    const ft = filterText.toLowerCase();
    filtered = filtered.filter(r => r.join(' ').toLowerCase().includes(ft));
  }

  if (statusFilter !== 'all') {
    const pctIdx = findHeaderIndex(['%','percent','progress','status']);
    if (pctIdx >= 0) {
      if (statusFilter === 'inprogress') {
        filtered = filtered.filter(r => {
          const v = Number((r[pctIdx]||'').toString().replace('%','')) || 0;
          return v < 100;
        });
      } else {
        filtered = filtered.filter(r => {
          const v = Number((r[pctIdx]||'').toString().replace('%','')) || 0;
          return v === 100;
        });
      }
    }
  }

  const dataTable = rowsToGanttData(filtered);

  const options = {
    height: Math.max(400, dataTable.getNumberOfRows() * 40),
    gantt: {
      trackHeight: 32,
      labelStyle: { fontName: 'Segoe UI', fontSize: 12, color:'#333' },
      percentEnabled: true
    }
  };

  const chart = new google.visualization.Gantt(document.getElementById('chart_div'));
  chart.draw(dataTable, options);
  showMessage('Chart digambar. Menampilkan ' + dataTable.getNumberOfRows() + ' baris.');
}

function applyFilters() {
  const txt = document.getElementById('searchInput').value || '';
  const status = document.getElementById('statusFilter').value;
  buildAndDraw(txt, status);
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
