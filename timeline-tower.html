<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TimeLine Tower – Gantt Dashboard (Clean)</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Charts -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', 'Inter', "Segoe UI", Roboto, Arial, sans-serif;
      background: #f5f7fb;
      margin: 0;
      padding: 0;
    }
    /* === NAVBAR === */
    .navbar-brand {
      font-weight: bold;
      font-size: 24px;
      color: #444;
    }
    .nav-link {
      color: #333 !important;
      transition: all 0.3s ease;
      padding: 8px 15px;
      border-radius: 6px;
    }
    .nav-link:hover {
      background-color: #f0f0f0;
      color: #007bff !important;
    }
    .dropdown-menu a.dropdown-item {
      font-size: 14px;
      color: #333;
      transition: all 0.2s ease;
    }
    .dropdown-menu a.dropdown-item:hover {
      background-color: #007bff;
      color: white;
    }

    /* Card Main */
    .card-main{
      background:#ffffff;
      border-radius:12px;
      padding:20px;
      box-shadow: 0 8px 24px rgba(22,34,60,0.06);
      margin: 24px auto 0 auto;
      max-width: 1200px;
    }
    .legend {display:flex;gap:12px;align-items:center;margin-top:8px;}
    .legend .item {display:flex;gap:8px;align-items:center;font-size:13px;color:#6c757d}
    .legend .swatch {width:14px;height:10px;border-radius:3px;display:inline-block;}
    #chart_div { width:100%; height:650px; background:#fff; border-radius:8px; padding:12px 18px; box-sizing:border-box; }
    .form-control, .form-select { min-width:210px; margin-right: 0.5rem; }
    @media (max-width:900px){
      #chart_div { height:520px; }
      .form-control, .form-select { min-width:120px; }
    }
    .warnings {
      background: linear-gradient(180deg,#fff8e5,#fff6e0);
      border:1px solid #ffe7b5;
      color:#6a4f00;
      padding:12px 14px;
      border-radius:8px;
      margin:12px 0;
      display:none;
      max-height:200px;
      overflow:auto;
      line-height:1.45;
      font-size:14px;
    }
    .warnings small { display:block; color:#6c757d; margin-top:6px }
    /* Preview & Debug hidden by default */
    .preview-wrap { display:none; margin-top:12px; border-radius:8px; overflow:auto; border:1px solid #f0f0f0; background:#fafafa; padding:10px; }
    table.preview { width:100%; border-collapse:collapse; font-size:13px; min-width:1200px; }
    table.preview th, table.preview td { border-bottom:1px solid #eee; padding:6px 8px; text-align:left; white-space:nowrap; }
    pre.debug { display:none; background:#0f1724; color:#f8fafc; padding:12px; border-radius:8px; margin-top:12px; max-height:220px; overflow:auto; }
  </style>
</head>
<body>

  <!-- NAVBAR Bootstrap -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><img src="PERFORMANCE TEAM.png" style="height: 40px; margin-right: 10px;">PERFORMANCE BAN-TAN</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">

          <!-- RANGKING -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="racingDropdown" role="button" data-bs-toggle="dropdown">Rangking</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">Rangking Household</a></li>
              <li><a class="dropdown-item" href="#">Rangking B2C</a></li>
              <li><a class="dropdown-item" href="#">Rangking B2B</a></li>
            </ul>
          </li>
          <!-- KPI 12 PI LATEN -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="kpi12piDropdown" role="button" data-bs-toggle="dropdown">KPI 12 PI Laten</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">Dashboard 12 PI Laten</a></li>
              <li><a class="dropdown-item" href="#">Ranking PI Laten HSA</a></li>
              <li><a class="dropdown-item" href="#">Indikator Not ACH</a></li>
              <li><a class="dropdown-item" href="#">Improvement PI Laten</a></li>
              <li><a class="dropdown-item" href="timeline-tower.html">TimeLine Tower</a></li>
            </ul>
          </li>
          <!-- KPI B2C -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="kpiioanDropdown" role="button" data-bs-toggle="dropdown">KPI B2C</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">Dashboard B2C</a></li>
              <li><a class="dropdown-item" href="#">Ranking B2C HSA</a></li>
              <li><a class="dropdown-item" href="#">Ranking B2C Mitra</a></li>
              <li><a class="dropdown-item" href="#">Indikator Not ACH</a></li>
              <li><a class="dropdown-item" href="#">Improvement B2C</a></li>
            </ul>
          </li>
          <!-- KPI NON SEKTOR B2B -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="kpiB2BDropdown" role="button" data-bs-toggle="dropdown">KPI Non Sektor B2B</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">HSI</a></li>
              <li><a class="dropdown-item" href="#">DATIN</a></li>
              <li><a class="dropdown-item" href="#">WIFI</a></li>
              <li><a class="dropdown-item" href="#">OLO</a></li>
            </ul>
          </li>
          <!-- KPI WSA -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="kpiWSADropdown" role="button" data-bs-toggle="dropdown">KPI WSA</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">FFG</a></li>
              <li><a class="dropdown-item" href="#">TTI</a></li>
              <li><a class="dropdown-item" href="#">Service Availability</a></li>
              <li><a class="dropdown-item" href="#">Assurance Guarantee</a></li>
              <li><a class="dropdown-item" href="#">TTR</a></li>
            </ul>
          </li>
          <!-- KPI MAINTENANCE -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="kpiMTCDropdown" role="button" data-bs-toggle="dropdown">KPI Maintenance</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">FTM</a></li>
              <li><a class="dropdown-item" href="#">OLT</a></li>
              <li><a class="dropdown-item" href="#">GAMAS</a></li>
              <li><a class="dropdown-item" href="#">Pengawasan Project P3</a></li>
              <li><a class="dropdown-item" href="#">Patroli Akses</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- FILTER DAN DASHBOARD -->
  <div class="card-main">
    <div class="d-flex align-items-center mb-2">
      <input id="searchInput" class="form-control" type="text" placeholder="Cari: Ticket, Site, Teknisi..." aria-label="search">
      <select id="statusFilter" class="form-select" aria-label="status">
        <option value="all">Semua status</option>
        <option value="inprogress">&lt;100% (In Progress)</option>
        <option value="completed">100% (Completed)</option>
      </select>
      <button id="btnSearch" class="btn btn-primary">Terapkan</button>
      <button id="btnToggleWarnings" class="btn btn-outline-secondary">Show Warnings</button>
      <button id="btnTogglePreview" class="btn btn-outline-secondary">Preview</button>
      <button id="btnToggleDebug" class="btn btn-outline-secondary">Debug</button>
    </div>
    <div class="legend">
      <div class="item"><span class="swatch" style="background:#28a745"></span> Completed (100%)</div>
      <div class="item"><span class="swatch" style="background:#ffb74d"></span> In progress (&lt;100%)</div>
      <div class="item"><span class="swatch" style="background:#90caf9"></span> No % shown</div>
    </div>
    <small class="d-block mt-2" style="color:#6c757d">Sumber: Google Sheet (CSV publik)</small>
    <div style="text-align:right">
      <small class="text-muted">Last update: <span id="lastUpdate">–</span></small>
    </div>
    <div id="warnings" class="warnings" role="status" aria-live="polite"></div>
    <div id="chart_card">
      <div id="chart_div">Memuat Gantt chart…</div>
    </div>
    <div id="preview_wrap" class="preview-wrap mt-3"></div>
    <pre id="debug" class="debug"></pre>
  </div>

<script>
const PUB_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcHZK2xNVK-lRfq_MnNF7MK_4x1iUQJL4ECSf7bBL51Yf7yHdbmGgv5RwtD0RZC6NULyTW7h3-E3o1/pub?gid=1842046587&single=true&output=csv';
const DEBUG_MODE = false;
let headers = [], rows = [], warnings = [];
let lastCsvText = '';

google.charts.load('current', {'packages':['gantt']});
google.charts.setOnLoadCallback(init);

document.getElementById('btnSearch').addEventListener('click', applyFilters);
document.getElementById('btnToggleWarnings').addEventListener('click', toggleWarnings);
document.getElementById('btnTogglePreview').addEventListener('click', togglePreview);
document.getElementById('btnToggleDebug').addEventListener('click', toggleDebug);

function byId(id){ return document.getElementById(id); }
function logDebug(txt){ if (!DEBUG_MODE) return; byId('debug').textContent += txt + '\n'; console.info(txt); }
function showWarnings(){ const el = byId('warnings'); if (!warnings.length){ el.style.display='none'; el.innerHTML=''; return;} el.style.display='block'; el.innerHTML = warnings.map(w => `<div>• ${escapeHtml(w)}</div>`).join('') + '<small style="display:block;margin-top:8px;color:#6c757d">Klik "Show Warnings" untuk sembunyikan.</small>'; }

async function init(){
  byId('lastUpdate').textContent = new Date().toLocaleString();
  try{
    const csv = await fetchCsv(PUB_CSV_URL);
    lastCsvText = csv;
    parseCsv(csv);
    renderPreview();
    drawCurrent();
  } catch(err){
    byId('chart_div').innerHTML = `<div style="padding:18px;color:#b00020">Gagal load data: ${escapeHtml(err.message)}</div>`;
  }
}
async function fetchCsv(url){
  const r = await fetch(url, {mode:'cors'});
  if (!r.ok) throw new Error('HTTP ' + r.status);
  return await r.text();
}
// --- CSV Parser and Chart Logic (tetap sesuai script lama, sudah bagus) ---
function parseCsv(text) {
  // ... Full CSV parser dari script sumber kamu, tidak dihapus ...
  // (kode parser dan renderPreview, findHeaderIndex, parseDateFlexible, rowsToGanttData, drawCurrent, applyFilters, helpers...)
  // Paste seluruh script parsing JS dari project awal di sini.
}
// --- END CSV Parser and Chart Logic ---

function toggleWarnings(){
  const el = byId('warnings');
  if (el.style.display === 'none' || el.style.display === ''){ el.style.display='block'; byId('btnToggleWarnings').textContent='Hide Warnings'; }
  else { el.style.display='none'; byId('btnToggleWarnings').textContent='Show Warnings'; }
}
function togglePreview(){
  const el = byId('preview_wrap');
  if (el.style.display === 'none' || el.style.display === ''){ el.style.display='block'; byId('btnTogglePreview').textContent='Hide Preview'; }
  else { el.style.display='none'; byId('btnTogglePreview').textContent='Preview'; }
}
function toggleDebug(){
  const el = byId('debug');
  if (el.style.display === 'none' || el.style.display === ''){ el.style.display='block'; byId('btnToggleDebug').textContent='Hide Debug'; }
  else { el.style.display='none'; byId('btnToggleDebug').textContent='Debug'; }
}
function applyFilters(){
  const q = byId('searchInput').value || '';
  const status = byId('statusFilter').value || 'all';
  drawCurrent(q, status);
  byId('lastUpdate').textContent = new Date().toLocaleString();
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
